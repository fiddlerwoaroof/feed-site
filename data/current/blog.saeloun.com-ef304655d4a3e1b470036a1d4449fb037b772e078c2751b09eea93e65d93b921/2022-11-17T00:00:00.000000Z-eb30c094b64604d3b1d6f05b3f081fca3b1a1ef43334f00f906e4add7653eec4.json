{
  "title":"Rails 7 fixes timezone awareness for tsrange and tstzrange columns",
  "date":"2022-11-17T00:00:00.000000Z",
  "author":null,
  "id":"https://blog.saeloun.com/2022/11/17/tsrange-timezone-bug.html",
  "link":"https://blog.saeloun.com/2022/11/17/tsrange-timezone-bug.html",
  "content":"<p>Postgres has a fantastic collection of column types \nthat makes it easy to store custom data. \nOne such type are Ranges which allow you to store a range of values. \nFor example, you can store a range of dates or a range of integers. \nWhen it comes to storing a range of timestamps, Postgres provides the <code class=\"highlighter-rouge\">tsrange</code> \nand <code class=\"highlighter-rouge\">tstzrange</code> column types which store a range of timestamps with \nand without timezones respectively.</p>\n\n<h3 id=\"before\">Before</h3>\n<p>Let’s create a column in a Rails module to store a range of timestamps.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-ruby\">  <span class=\"c1\"># First we create a migration to add the column</span>\n  <span class=\"k\">class</span> <span class=\"nc\">AddTimestampRangeToEmployees</span> <span class=\"o\">&lt;</span> <span class=\"no\">ActiveRecord</span><span class=\"o\">::</span><span class=\"no\">Migration</span><span class=\"p\">[</span><span class=\"mf\">7.0</span><span class=\"p\">]</span>\n    <span class=\"k\">def</span> <span class=\"nf\">change</span>\n      <span class=\"n\">add_column</span> <span class=\"ss\">:employees</span><span class=\"p\">,</span> <span class=\"ss\">:tenure</span><span class=\"p\">,</span> <span class=\"ss\">:tsrange</span><span class=\"p\">,</span> <span class=\"ss\">array: </span><span class=\"kp\">true</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span></code></pre></figure>\n\n<p>Now let’s store a range of timestamps in this column.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-ruby\">  <span class=\"err\">➜</span>  <span class=\"n\">rails</span> <span class=\"n\">c</span>\n  <span class=\"no\">Loading</span> <span class=\"n\">development</span> <span class=\"n\">environment</span> <span class=\"p\">(</span><span class=\"no\">Rails</span> <span class=\"mf\">7.0</span><span class=\"o\">.</span><span class=\"mi\">2</span><span class=\"p\">)</span>\n  <span class=\"n\">irb</span><span class=\"p\">(</span><span class=\"n\">main</span><span class=\"p\">):</span><span class=\"mo\">001</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span> <span class=\"no\">Employee</span><span class=\"p\">.</span><span class=\"nf\">create!</span><span class=\"p\">(</span><span class=\"ss\">tenure: </span><span class=\"mi\">5</span><span class=\"p\">.</span><span class=\"nf\">years</span><span class=\"p\">.</span><span class=\"nf\">ago</span><span class=\"o\">..</span><span class=\"no\">DateTime</span><span class=\"p\">.</span><span class=\"nf\">yesterday</span><span class=\"p\">,</span> <span class=\"ss\">name: </span><span class=\"s2\">&quot;John&quot;</span><span class=\"p\">)</span>\n  <span class=\"o\">=&gt;</span> <span class=\"c1\">#&lt;Employee id: 1, tenure: [&quot;2017-11-03 14:10:17.844978 UTC&quot;, &quot;2022-11-03 14:10:17.844978 UTC&quot;], name: &quot;John&quot;&gt;</span></code></pre></figure>\n\n<p>This works as expected. \nHowever, if we set a timezone in the application config \n(and then make <code class=\"highlighter-rouge\">tsrange</code> timezone aware), \nwe get a TypeError.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-ruby\">  <span class=\"c1\"># config/application.rb</span>\n  <span class=\"n\">config</span><span class=\"p\">.</span><span class=\"nf\">time_zone</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;Asia/Kolkata&quot;</span>\n  <span class=\"no\">ActiveRecord</span><span class=\"o\">::</span><span class=\"no\">Base</span><span class=\"p\">.</span><span class=\"nf\">time_zone_aware_types</span> <span class=\"o\">+=</span> <span class=\"p\">[</span><span class=\"ss\">:tsrange</span><span class=\"p\">]</span></code></pre></figure>\n\n<p>Now let’s try again!</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-ruby\">  <span class=\"err\">➜</span>  <span class=\"n\">rails</span> <span class=\"n\">c</span>\n  <span class=\"no\">Loading</span> <span class=\"n\">development</span> <span class=\"n\">environment</span> <span class=\"p\">(</span><span class=\"no\">Rails</span> <span class=\"mf\">7.0</span><span class=\"o\">.</span><span class=\"mi\">2</span><span class=\"p\">)</span>\n  <span class=\"n\">irb</span><span class=\"p\">(</span><span class=\"n\">main</span><span class=\"p\">):</span><span class=\"mo\">001</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span> <span class=\"no\">Employee</span><span class=\"p\">.</span><span class=\"nf\">create!</span><span class=\"p\">(</span><span class=\"ss\">tenure: </span><span class=\"mi\">5</span><span class=\"p\">.</span><span class=\"nf\">years</span><span class=\"p\">.</span><span class=\"nf\">ago</span><span class=\"o\">..</span><span class=\"no\">DateTime</span><span class=\"p\">.</span><span class=\"nf\">yesterday</span><span class=\"p\">,</span> <span class=\"ss\">name: </span><span class=\"s2\">&quot;John&quot;</span><span class=\"p\">)</span>\n  <span class=\"sr\">/Users/s</span><span class=\"n\">waathi</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"nf\">rbenv</span><span class=\"o\">/</span><span class=\"n\">versions</span><span class=\"o\">/</span><span class=\"mf\">3.1</span><span class=\"o\">.</span><span class=\"mi\">2</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">ruby</span><span class=\"o\">/</span><span class=\"n\">gems</span><span class=\"o\">/</span><span class=\"mf\">3.1</span><span class=\"o\">.</span><span class=\"mi\">0</span><span class=\"o\">/</span><span class=\"n\">gems</span><span class=\"o\">/</span><span class=\"n\">activesupport</span><span class=\"o\">-</span><span class=\"mf\">7.0</span><span class=\"o\">.</span><span class=\"mi\">2</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">active_support</span><span class=\"o\">/</span><span class=\"n\">core_ext</span><span class=\"o\">/</span><span class=\"n\">range</span><span class=\"o\">/</span><span class=\"n\">each</span><span class=\"p\">.</span><span class=\"nf\">rb</span><span class=\"p\">:</span><span class=\"mi\">19</span><span class=\"ss\">:in</span> <span class=\"sb\">`ensure_iteration_allowed': can't iterate from ActiveSupport::TimeWithZone (TypeError)\n  /Users/swaathi/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/activesupport-7.0.2/lib/active_support/core_ext/range/each.rb:19:in `</span><span class=\"n\">ensure_iteration_allowed</span><span class=\"s1\">': can'</span><span class=\"n\">t</span> <span class=\"n\">iterate</span> <span class=\"n\">from</span> <span class=\"no\">ActiveSupport</span><span class=\"o\">::</span><span class=\"no\">TimeWithZone</span> <span class=\"p\">(</span><span class=\"no\">TypeError</span><span class=\"p\">)</span></code></pre></figure>\n\n<h3 id=\"after\">After</h3>\n\n<p>Thanks to <a href=\"https://github.com/rails/rails/pull/45348\">this PR</a>, \nthe app timezone is now retained when storing a range of timestamps. \nLet’s try again!</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-ruby\">  <span class=\"err\">➜</span>  <span class=\"n\">rails</span> <span class=\"n\">c</span>\n  <span class=\"no\">Loading</span> <span class=\"n\">development</span> <span class=\"n\">environment</span> <span class=\"p\">(</span><span class=\"no\">Rails</span> <span class=\"mf\">7.0</span><span class=\"o\">.</span><span class=\"mi\">2</span><span class=\"p\">)</span>\n  <span class=\"n\">irb</span><span class=\"p\">(</span><span class=\"n\">main</span><span class=\"p\">):</span><span class=\"mo\">001</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span> <span class=\"no\">Employee</span><span class=\"p\">.</span><span class=\"nf\">create!</span><span class=\"p\">(</span><span class=\"ss\">tenure: </span><span class=\"mi\">5</span><span class=\"p\">.</span><span class=\"nf\">years</span><span class=\"p\">.</span><span class=\"nf\">ago</span><span class=\"o\">..</span><span class=\"no\">DateTime</span><span class=\"p\">.</span><span class=\"nf\">yesterday</span><span class=\"p\">,</span> <span class=\"ss\">name: </span><span class=\"s2\">&quot;John&quot;</span><span class=\"p\">)</span>\n  <span class=\"o\">=&gt;</span> <span class=\"c1\">#&lt;Employee id: 1, tenure: [&quot;2017-11-03 13:36:14.419774000 IST +05:30&quot;, &quot;2022-11-03 13:36:14.419774000 IST +05:30&quot;], name: &quot;John&quot;&gt;</span></code></pre></figure>\n\n"
}