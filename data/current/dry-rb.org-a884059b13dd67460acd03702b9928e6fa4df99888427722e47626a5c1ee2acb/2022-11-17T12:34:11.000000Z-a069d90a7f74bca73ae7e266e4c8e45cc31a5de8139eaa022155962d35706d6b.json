{
  "title":"dry-validation 1.0.0 released",
  "date":"2022-11-17T12:34:11.000000Z",
  "author":"solnic",
  "id":"http://dry-rb.org/news/2019/06/10/dry-validation-1-0-0-released/",
  "link":"http://dry-rb.org/news/2019/06/10/dry-validation-1-0-0-released/",
  "content":"<p>We're very happy to announce the release of dry-validation 1.0.0!</p>\n\n<p>This is a big release: it includes a rewritten schema DSL, released as <a href=\"/gems/dry-schema\">dry-schema</a>, and a completely redesigned validation system. If you're interested to know the reasoning behind these changes, please refer to the &quot;<a href=\"https://discourse.dry-rb.org/t/plans-for-dry-validation-dry-schema-a-new-gem/215\">Plans for dry-validation + dry-schema (a new gem!)</a>&quot; post on our forum. Yes, it's from February 2017, this took a while, but it was totally worth the wait. Continue reading to see why.</p>\n<h2 id=\"new-old-schema-dsl\" class=\"hd\"><a name=\"new-old-schema-dsl\" class=\"anchor\" href=\"#new-old-schema-dsl\">            \n</a>New-old schema DSL</h2>\n<p>The schema DSL has been rewritten from scratch and not only did it fix dozens of known issues, it also introduced a couple of new features. That said, some complex features that didn't fit anymore were removed. In dry-validation 1.0.0, the schema DSL is delegated to dry-schema and you can still define 3 types of schemas:</p>\n\n<ol>\n<li><code>schema</code> - a plain schema that does not perform any coercions</li>\n<li><code>params</code> - a schema with coercions optimized for HTTP params</li>\n<li><code>json</code> - a schema with coercions optimized for JSON</li>\n</ol>\n\n<p>The syntax for defining keys with validations is almost identicial to the one you know from previous versions of dry-validation. However, there's a big conceptual difference between those earlier versions and how dry-validation 1.0.0 is intended to be used now.</p>\n<h2 id=\"contracts-with-rules\" class=\"hd\"><a name=\"contracts-with-rules\" class=\"anchor\" href=\"#contracts-with-rules\">            \n</a>Contracts with rules</h2>\n<p>We have a completely new concept called <code>Contract</code> that allows you to define a schema and <strong>domain validation rules</strong>. The new rule system is completely decoupled from the schema validation, but it's still <strong>type-safe</strong>, which means that <strong>when you define a rule you can assume the types of the values are correct</strong>. This removes the need to perform any additional checks in validation rules and you are going to love this.</p>\n\n<p>Here's a simple example where we define a contract for a new user data:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"k\">class</span> <span class=\"nc\">NewUserContract</span> <span class=\"o\">&lt;</span> <span class=\"no\">Dry</span><span class=\"o\">::</span><span class=\"no\">Validation</span><span class=\"o\">::</span><span class=\"no\">Contract</span>\n  <span class=\"n\">params</span> <span class=\"k\">do</span>\n    <span class=\"n\">required</span><span class=\"p\">(</span><span class=\"ss\">:name</span><span class=\"p\">).</span><span class=\"nf\">filled</span><span class=\"p\">(</span><span class=\"ss\">:string</span><span class=\"p\">)</span>\n    <span class=\"n\">required</span><span class=\"p\">(</span><span class=\"ss\">:age</span><span class=\"p\">).</span><span class=\"nf\">filled</span><span class=\"p\">(</span><span class=\"ss\">:integer</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"n\">rule</span><span class=\"p\">(</span><span class=\"ss\">:name</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"n\">key</span><span class=\"p\">.</span><span class=\"nf\">failure</span><span class=\"p\">(</span><span class=\"s2\">&quot;is too short&quot;</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"n\">value</span><span class=\"p\">.</span><span class=\"nf\">length</span> <span class=\"o\">&lt;</span> <span class=\"mi\">3</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"n\">rule</span><span class=\"p\">(</span><span class=\"ss\">:age</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"n\">key</span><span class=\"p\">.</span><span class=\"nf\">failure</span><span class=\"p\">(</span><span class=\"s2\">&quot;you must be at least 13 years old&quot;</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"n\">value</span> <span class=\"o\">&lt;</span> <span class=\"mi\">13</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n<p>If you are familiar with the old version, your immediate reaction might be &quot;oh that's more code, why not just define these checks in the schema?&quot; That's a good question to ask! It's still possible to use all the known predicates so, technically speaking, you could perform these checks via the schema <strong>but</strong> it's not recommended. Starting with 1.0.0, we're moving to a new way of thinking about validations by splitting them into basic structural and type checks handled by schemas and domain validations handled by contracts and their rules. This is a good way of separating concerns to make your code cleaner, simpler and more reusable.</p>\n\n<p>If the amount of code you need to write is a concern, don't worry, because we have <a href=\"/gems/dry-validation/1.0/macros\">a new macro system</a> in place to DRY things up.</p>\n<h2 id=\"improved-messages\" class=\"hd\"><a name=\"improved-messages\" class=\"anchor\" href=\"#improved-messages\">            \n</a>Improved messages</h2>\n<p>One of the biggest limitations in the previous version was the way you could provide custom error messages. Starting from 1.0.0, you have complete control over this process. You can now:</p>\n\n<ul>\n<li>Provide a message as a plain string, e.g. <code>key.failure(&quot;oops this is wrong&quot;)</code></li>\n<li>Provide a message using a locale identifier, e.g. <code>key.failure(:invalid)</code></li>\n<li>Pass extra data when using locales, e.g. <code>key.failure(:invalid, more: &quot;info&quot;, goes: &quot;here&quot;)</code></li>\n<li>Pass additional metadata in addition to the message text, e.g. <code>key.failure(text: &quot;oops this is wrong&quot;, code: :red)</code></li>\n</ul>\n\n<p>On top of this, we still support localized backends using plain <code>YAML</code> or <code>I18n</code> gem.</p>\n<h2 id=\"base-messages\" class=\"hd\"><a name=\"base-messages\" class=\"anchor\" href=\"#base-messages\">            \n</a>Base messages</h2>\n<p>Another nice improvement is support for <strong>base messages</strong>. This means you can provide a message that will be associated with the whole input, instead of a specific key.</p>\n\n<p>Here's an example:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"k\">class</span> <span class=\"nc\">EventContract</span> <span class=\"o\">&lt;</span> <span class=\"no\">Dry</span><span class=\"o\">::</span><span class=\"no\">Validation</span><span class=\"o\">::</span><span class=\"no\">Contract</span>\n  <span class=\"n\">option</span> <span class=\"ss\">:today</span><span class=\"p\">,</span> <span class=\"ss\">default: </span><span class=\"no\">Date</span><span class=\"p\">.</span><span class=\"nf\">method</span><span class=\"p\">(</span><span class=\"ss\">:today</span><span class=\"p\">)</span>\n\n  <span class=\"n\">params</span> <span class=\"k\">do</span>\n    <span class=\"n\">required</span><span class=\"p\">(</span><span class=\"ss\">:start_date</span><span class=\"p\">).</span><span class=\"nf\">value</span><span class=\"p\">(</span><span class=\"ss\">:date</span><span class=\"p\">)</span>\n    <span class=\"n\">required</span><span class=\"p\">(</span><span class=\"ss\">:end_date</span><span class=\"p\">).</span><span class=\"nf\">value</span><span class=\"p\">(</span><span class=\"ss\">:date</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"n\">rule</span> <span class=\"k\">do</span>\n    <span class=\"k\">if</span> <span class=\"n\">today</span><span class=\"p\">.</span><span class=\"nf\">saturday?</span> <span class=\"o\">||</span> <span class=\"n\">today</span><span class=\"p\">.</span><span class=\"nf\">sunday?</span>\n      <span class=\"n\">base</span><span class=\"p\">.</span><span class=\"nf\">failure</span><span class=\"p\">(</span><span class=\"s1\">'creating events is allowed only on weekdays'</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n<p>Now we can access base errors (assuming it's a weekend):</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"n\">contract</span> <span class=\"o\">=</span> <span class=\"no\">EventContract</span><span class=\"p\">.</span><span class=\"nf\">new</span>\n\n<span class=\"n\">contract</span><span class=\"p\">.</span><span class=\"nf\">call</span><span class=\"p\">(</span><span class=\"ss\">start_date: </span><span class=\"no\">Date</span><span class=\"p\">.</span><span class=\"nf\">today</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"ss\">end_date: </span><span class=\"no\">Date</span><span class=\"p\">.</span><span class=\"nf\">today</span><span class=\"o\">+</span><span class=\"mi\">2</span><span class=\"p\">).</span><span class=\"nf\">errors</span>\n<span class=\"c1\"># #&lt;Dry::Validation::MessageSet</span>\n<span class=\"c1\">#   messages=[</span>\n<span class=\"c1\">#     #&lt;Dry::Validation::Message text=&quot;creating events is allowed only on weekdays&quot; path=[nil] meta={}&gt;</span>\n<span class=\"c1\">#   ]</span>\n<span class=\"c1\">#   options={}</span>\n<span class=\"c1\"># &gt;</span>\n</code></pre></div><h2 id=\"macros\" class=\"hd\"><a name=\"macros\" class=\"anchor\" href=\"#macros\">            \n</a>Macros</h2>\n<p>As mentioned above, you can use the new macro system to reduce code duplication. Currently, there's only one built-in macro, called <code>:acceptance</code>, but we'll be adding more.</p>\n\n<p>Here's an example how you could use the <code>:acceptance</code> macro:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"k\">class</span> <span class=\"nc\">NewUserContract</span> <span class=\"o\">&lt;</span> <span class=\"no\">Dry</span><span class=\"o\">::</span><span class=\"no\">Validation</span><span class=\"o\">::</span><span class=\"no\">Contract</span>\n  <span class=\"n\">schema</span> <span class=\"k\">do</span>\n    <span class=\"n\">required</span><span class=\"p\">(</span><span class=\"ss\">:email</span><span class=\"p\">).</span><span class=\"nf\">filled</span><span class=\"p\">(</span><span class=\"ss\">:string</span><span class=\"p\">)</span>\n    <span class=\"n\">required</span><span class=\"p\">(</span><span class=\"ss\">:terms</span><span class=\"p\">).</span><span class=\"nf\">filled</span><span class=\"p\">(</span><span class=\"ss\">:bool</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"n\">rule</span><span class=\"p\">(</span><span class=\"ss\">:terms</span><span class=\"p\">).</span><span class=\"nf\">validate</span><span class=\"p\">(</span><span class=\"ss\">:acceptance</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n\n<span class=\"n\">contract</span> <span class=\"o\">=</span> <span class=\"no\">NewUserContract</span><span class=\"p\">.</span><span class=\"nf\">new</span>\n\n<span class=\"n\">contract</span><span class=\"p\">.</span><span class=\"nf\">call</span><span class=\"p\">(</span><span class=\"ss\">email: </span><span class=\"s2\">&quot;jane@doe.org&quot;</span><span class=\"p\">,</span> <span class=\"ss\">terms: </span><span class=\"s2\">&quot;false&quot;</span><span class=\"p\">).</span><span class=\"nf\">errors</span><span class=\"p\">.</span><span class=\"nf\">to_h</span>\n<span class=\"c1\"># =&gt; {:terms=&gt;[&quot;must accept terms&quot;]}</span>\n\n<span class=\"n\">contract</span><span class=\"p\">.</span><span class=\"nf\">call</span><span class=\"p\">(</span><span class=\"ss\">email: </span><span class=\"s2\">&quot;jane@doe.org&quot;</span><span class=\"p\">,</span> <span class=\"ss\">terms: </span><span class=\"s2\">&quot;true&quot;</span><span class=\"p\">).</span><span class=\"nf\">errors</span><span class=\"p\">.</span><span class=\"nf\">to_h</span>\n<span class=\"c1\"># =&gt; {}</span>\n</code></pre></div>\n<p>Defining your own macros is very simple and you're encouraged to do so. Let's say we want to encapsulate checking if a string is of a minimum length, here's how you could do it with a macro:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"k\">class</span> <span class=\"nc\">ApplicationContract</span> <span class=\"o\">&lt;</span> <span class=\"no\">Dry</span><span class=\"o\">::</span><span class=\"no\">Validation</span><span class=\"o\">::</span><span class=\"no\">Contract</span>\n  <span class=\"n\">register_macro</span><span class=\"p\">(</span><span class=\"ss\">:min_length</span><span class=\"p\">)</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">macro</span><span class=\"ss\">:|</span>\n    <span class=\"n\">key</span><span class=\"p\">.</span><span class=\"nf\">failure</span><span class=\"p\">(</span><span class=\"s2\">&quot;is too short&quot;</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"n\">value</span><span class=\"p\">.</span><span class=\"nf\">length</span> <span class=\"o\">&lt;</span> <span class=\"n\">macro</span><span class=\"p\">.</span><span class=\"nf\">args</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n<p>Now we can use our <code>:min_length</code> macro in other contract classes:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"k\">class</span> <span class=\"nc\">NewUserContract</span> <span class=\"o\">&lt;</span> <span class=\"no\">ApplicationContract</span>\n  <span class=\"n\">schema</span> <span class=\"k\">do</span>\n    <span class=\"n\">required</span><span class=\"p\">(</span><span class=\"ss\">:email</span><span class=\"p\">).</span><span class=\"nf\">filled</span><span class=\"p\">(</span><span class=\"ss\">:string</span><span class=\"p\">)</span>\n    <span class=\"n\">required</span><span class=\"p\">(</span><span class=\"ss\">:password</span><span class=\"p\">).</span><span class=\"nf\">filled</span><span class=\"p\">(</span><span class=\"ss\">:string</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"n\">rule</span><span class=\"p\">(</span><span class=\"ss\">:password</span><span class=\"p\">).</span><span class=\"nf\">validate</span><span class=\"p\">(</span><span class=\"ss\">min_length: </span><span class=\"mi\">12</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n\n<span class=\"n\">contract</span> <span class=\"o\">=</span> <span class=\"no\">NewUserContract</span><span class=\"p\">.</span><span class=\"nf\">new</span>\n\n<span class=\"n\">contract</span><span class=\"p\">.</span><span class=\"nf\">call</span><span class=\"p\">(</span><span class=\"ss\">email: </span><span class=\"s2\">&quot;jane@doe.org&quot;</span><span class=\"p\">,</span> <span class=\"ss\">terms: </span><span class=\"s2\">&quot;false&quot;</span><span class=\"p\">,</span> <span class=\"ss\">password: </span><span class=\"s2\">&quot;secret&quot;</span><span class=\"p\">).</span><span class=\"nf\">errors</span><span class=\"p\">.</span><span class=\"nf\">to_h</span>\n<span class=\"c1\"># =&gt; {:password=&gt;[&quot;is too short&quot;]}</span>\n</code></pre></div>\n<p>The posibilities are endless and I'm sure we'll soon have a nice collection of macros either built into the main gem or provided as an extension.</p>\n<h2 id=\"improved-validation-of-array-elements\" class=\"hd\"><a name=\"improved-validation-of-array-elements\" class=\"anchor\" href=\"#improved-validation-of-array-elements\">            \n</a>Improved validation of array elements</h2>\n<p>Validating array elements can be tricky business, but it's become nice and simple in dry-validation 1.0.0. It works using the same mechanism as other value types - an array element will not be checked by a rule unless the corresponding schema checks passed.</p>\n\n<p>To validate array elements, use <code>Rule#each</code>:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"k\">class</span> <span class=\"nc\">NewSongContract</span> <span class=\"o\">&lt;</span> <span class=\"no\">Dry</span><span class=\"o\">::</span><span class=\"no\">Validation</span><span class=\"o\">::</span><span class=\"no\">Contract</span>\n  <span class=\"n\">params</span> <span class=\"k\">do</span>\n    <span class=\"n\">required</span><span class=\"p\">(</span><span class=\"ss\">:artist</span><span class=\"p\">).</span><span class=\"nf\">filled</span><span class=\"p\">(</span><span class=\"ss\">:string</span><span class=\"p\">)</span>\n    <span class=\"n\">required</span><span class=\"p\">(</span><span class=\"ss\">:title</span><span class=\"p\">).</span><span class=\"nf\">filled</span><span class=\"p\">(</span><span class=\"ss\">:string</span><span class=\"p\">)</span>\n    <span class=\"n\">required</span><span class=\"p\">(</span><span class=\"ss\">:tags</span><span class=\"p\">).</span><span class=\"nf\">array</span><span class=\"p\">(</span><span class=\"ss\">:string</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"n\">rule</span><span class=\"p\">(</span><span class=\"ss\">:tags</span><span class=\"p\">).</span><span class=\"nf\">each</span> <span class=\"k\">do</span>\n    <span class=\"n\">key</span><span class=\"p\">.</span><span class=\"nf\">failure</span><span class=\"p\">(</span><span class=\"s2\">&quot;tag length must be at least 3&quot;</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"n\">value</span><span class=\"p\">.</span><span class=\"nf\">length</span> <span class=\"o\">&lt;</span> <span class=\"mi\">3</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n<p>Now let's see it in action:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"n\">contract</span> <span class=\"o\">=</span> <span class=\"no\">NewSongContract</span><span class=\"p\">.</span><span class=\"nf\">new</span>\n\n<span class=\"n\">contract</span><span class=\"o\">.</span><span class=\"p\">(</span><span class=\"ss\">artist: </span><span class=\"s2\">&quot;Queen&quot;</span><span class=\"p\">,</span> <span class=\"ss\">title: </span><span class=\"s2\">&quot;Bohemian Rhapsody&quot;</span><span class=\"p\">,</span> <span class=\"ss\">tags: </span><span class=\"p\">[</span><span class=\"s2\">&quot;rock&quot;</span><span class=\"p\">,</span> <span class=\"mi\">123</span><span class=\"p\">,</span> <span class=\"s2\">&quot;ab&quot;</span><span class=\"p\">]).</span><span class=\"nf\">errors</span><span class=\"p\">.</span><span class=\"nf\">to_h</span>\n<span class=\"c1\"># =&gt; {:tags=&gt;{1=&gt;[&quot;must be a string&quot;], 2=&gt;[&quot;tag length must be at least 3&quot;]}</span>\n</code></pre></div>\n<p>Notice that our rule did not crash on <code>123</code> value even though <code>Integer</code> does not implement <code>length</code> - instead, we got a nice error that the second element must be a string. This is how type safety in rules work.</p>\n<h2 id=\"upgrading-from-dry-validation-0-x\" class=\"hd\"><a name=\"upgrading-from-dry-validation-0-x\" class=\"anchor\" href=\"#upgrading-from-dry-validation-0-x\">            \n</a>Upgrading from dry-validation 0.x</h2>\n<p>Please refer to the comprehensive guide &quot;<a href=\"https://www.morozov.is/2019/05/31/upgrading-dry-gems.html\">dry-rb 1.0: upgrading validations, types and schemas</a>,&quot; written by Igor Morozov. He's done a terrific job explaining the process.</p>\n\n<p>Additionally, check out:</p>\n\n<ul>\n<li>dry-validation 1.0.0 <a href=\"https://github.com/dry-rb/dry-validation/blob/main/CHANGELOG.md#v100-2019-06-10\">CHANGELOG</a></li>\n<li>dry-types 1.0.0 <a href=\"https://github.com/dry-rb/dry-types/blob/main/CHANGELOG.md#v100-2019-04-23\">CHANGELOG</a></li>\n<li>dry-schema 1.0.0 <a href=\"https://github.com/dry-rb/dry-schema/blob/main/CHANGELOG.md\">CHANGELOG</a>s</li>\n</ul>\n\n<p>If you need help with upgrading, <strong>please do not hesitate to ask questions either on our <a href=\"https://discourse.dry-rb.org\">discussion forum</a> or <a href=\"https://dry-rb.zulipchat.com\">community chat</a></strong>.</p>\n<h2 id=\"thank-you\" class=\"hd\"><a name=\"thank-you\" class=\"anchor\" href=\"#thank-you\">            \n</a>Thank you</h2>\n<p>Thank you to all the contributors and early adopters who helped us shape dry-validation. This has been a big effort and we're very happy with the results. Please check it out and let us know what you think!</p>\n"
}