{
  "title":"Introducing dry-effects",
  "date":"2022-11-17T12:34:11.000000Z",
  "author":"flash-gordon",
  "id":"http://dry-rb.org/news/2019/10/03/introducing-dry-effects/",
  "link":"http://dry-rb.org/news/2019/10/03/introducing-dry-effects/",
  "content":"<p>Today we're introducing another gem and supercharging our toolset: say hello to dry-effects!</p>\n\n<p>dry-effects is an implementation of algebraic effects in Ruby. Sound scary? Fear not! After a few examples, it'll feel very natural and compelling.</p>\n<h2 id=\"struggling-with-side-effects\" class=\"hd\"><a name=\"struggling-with-side-effects\" class=\"anchor\" href=\"#struggling-with-side-effects\">            \n</a>Struggling with side effects</h2>\n<p>Writing purely functional code can be an attractive idea; it makes your code robust, testable, ... and useless! Indeed, if code doesn't perform any side effects, such as reading/writing data to the disc or network communications, the only thing it actually does is heating the CPU. On the other hand, side effects remove determinism from the code, making testing challenging. Here come algebraic effects, the underlying theory powering dry-effects.</p>\n<h2 id=\"understanding-effects\" class=\"hd\"><a name=\"understanding-effects\" class=\"anchor\" href=\"#understanding-effects\">            \n</a>Understanding effects</h2>\n<p>There are two main parts to effects and effectful systems:</p>\n\n<ol>\n<li>Replace side effects with effects. These two are not the same, they are not even similar. Side effects are by definition not expected by the calling code. One cannot say if there are side effects judging by the interface. On the contrary, effects are explicitly included in interfaces; they <em>are expected</em>.</li>\n<li>Running code with effects requires handling. This must be done explicitly, so that effects don't propagate straight to the outside world.</li>\n</ol>\n\n<p>These two things combined give you full control over effects in your application.</p>\n<h2 id=\"taming-effects-with-dry-effects\" class=\"hd\"><a name=\"taming-effects-with-dry-effects\" class=\"anchor\" href=\"#taming-effects-with-dry-effects\">            \n</a>Taming effects with dry-effects</h2>\n<p>dry-effects uses mixins for making (or introducing) and handling (or eliminating) effects.</p>\n\n<p>For example, this code uses the effect of getting the current time:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"k\">class</span> <span class=\"nc\">CreateSubscription</span>\n  <span class=\"kp\">include</span> <span class=\"no\">Dry</span><span class=\"o\">::</span><span class=\"no\">Effects</span><span class=\"o\">.</span><span class=\"no\">CurrentTime</span>\n\n  <span class=\"k\">def</span> <span class=\"nf\">call</span><span class=\"p\">(</span><span class=\"n\">values</span><span class=\"p\">)</span>\n    <span class=\"n\">subscription_repo</span><span class=\"p\">.</span><span class=\"nf\">create</span><span class=\"p\">(</span><span class=\"n\">values</span><span class=\"p\">.</span><span class=\"nf\">merge</span><span class=\"p\">(</span><span class=\"ss\">start_at: </span><span class=\"n\">current_time</span><span class=\"p\">))</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n<p>To run it, there must be a handler:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"c1\"># Rack middleware is a perfect example of a place</span>\n<span class=\"c1\"># where effects can be handled.</span>\n\n<span class=\"k\">class</span> <span class=\"nc\">WithCurrentTime</span>\n  <span class=\"kp\">include</span> <span class=\"no\">Dry</span><span class=\"o\">::</span><span class=\"no\">Effects</span><span class=\"o\">::</span><span class=\"no\">Handler</span><span class=\"o\">.</span><span class=\"no\">CurrentTime</span>\n\n  <span class=\"k\">def</span> <span class=\"nf\">initialize</span><span class=\"p\">(</span><span class=\"n\">app</span><span class=\"p\">)</span>\n    <span class=\"vi\">@app</span> <span class=\"o\">=</span> <span class=\"n\">app</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"k\">def</span> <span class=\"nf\">call</span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">)</span>\n    <span class=\"n\">with_current_time</span> <span class=\"p\">{</span> <span class=\"vi\">@app</span><span class=\"o\">.</span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">)</span> <span class=\"p\">}</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n<p>So how is this better than <code>Time.now</code>? You get testable code for free. An RSpec example:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"kp\">include</span> <span class=\"no\">Dry</span><span class=\"o\">::</span><span class=\"no\">Effects</span><span class=\"o\">::</span><span class=\"no\">Handler</span><span class=\"o\">.</span><span class=\"no\">CurrentTime</span>\n\n<span class=\"n\">subject</span><span class=\"p\">(</span><span class=\"ss\">:create_subscription</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"no\">CreateSubscription</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"p\">}</span>\n\n<span class=\"n\">example</span> <span class=\"s2\">&quot;creating subscription on New Year's Eve&quot;</span> <span class=\"k\">do</span>\n  <span class=\"n\">with_current_time</span><span class=\"p\">(</span><span class=\"nb\">proc</span> <span class=\"p\">{</span> <span class=\"no\">Time</span><span class=\"p\">.</span><span class=\"nf\">new</span><span class=\"p\">(</span><span class=\"mi\">2019</span><span class=\"p\">,</span> <span class=\"mi\">12</span><span class=\"p\">,</span> <span class=\"mi\">31</span><span class=\"p\">,</span> <span class=\"mi\">12</span><span class=\"p\">)</span> <span class=\"p\">})</span> <span class=\"k\">do</span>\n    <span class=\"n\">create_subscription</span><span class=\"o\">.</span><span class=\"p\">(</span><span class=\"o\">...</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n<p>Why would you use dry-effects for this instead of specialized solutions? Because it provides a universal interface to all effects, it's not limited to Ruby. For instance, getting the current time in React would look very similar:</p>\n<div class=\"highlight\"><pre class=\"syntax javascript\"><code><span class=\"kd\">const</span> <span class=\"nx\">CurrentTime</span> <span class=\"o\">=</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"kd\">const</span> <span class=\"nx\">currentTime</span> <span class=\"o\">=</span> <span class=\"nx\">useCurrentTime</span><span class=\"p\">();</span>\n\n  <span class=\"k\">return</span> <span class=\"p\">(</span>\n    <span class=\"o\">&lt;</span><span class=\"nx\">div</span> <span class=\"nx\">className</span><span class=\"o\">=</span><span class=\"dl\">&quot;</span><span class=\"s2\">current-time</span><span class=\"dl\">&quot;</span><span class=\"o\">&gt;</span>\n      <span class=\"p\">{</span><span class=\"nx\">currentTime</span><span class=\"p\">.</span><span class=\"nx\">getHours</span><span class=\"p\">()}:{</span><span class=\"nx\">currentTime</span><span class=\"p\">.</span><span class=\"nx\">getMinutes</span><span class=\"p\">()}</span>\n    <span class=\"o\">&lt;</span><span class=\"sr\">/div</span><span class=\"err\">&gt;\n</span>  <span class=\"p\">);</span>\n<span class=\"p\">};</span>\n</code></pre></div>\n<p>Yes, React relies on algebraic effects under the hood; maybe you already use them!</p>\n<h2 id=\"what-else\" class=\"hd\"><a name=\"what-else\" class=\"anchor\" href=\"#what-else\">            \n</a>What else?</h2>\n<p>dry-effects v0.1 is already out and comes with quite a few effects supported out of the box. Some of them are “classic” and some are experimental, 17 in total.</p>\n\n<p>Here are some:</p>\n\n<ul>\n<li>Accessing current time</li>\n<li>Providing context</li>\n<li>Sharing state</li>\n<li>Providing environment (as opposed to accessing and manipulating <code>ENV</code>)</li>\n<li>Caching</li>\n<li>Locking</li>\n<li>Deferred and parallel code execution</li>\n</ul>\n\n<p>One of the most compelling examples is dependency injection:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"k\">class</span> <span class=\"nc\">CreateUser</span>\n  <span class=\"kp\">include</span> <span class=\"no\">Dry</span><span class=\"o\">::</span><span class=\"no\">Effects</span><span class=\"o\">.</span><span class=\"no\">Resolve</span><span class=\"p\">(</span><span class=\"ss\">:user_repo</span><span class=\"p\">)</span>\n\n  <span class=\"k\">def</span> <span class=\"nf\">call</span><span class=\"p\">(</span><span class=\"n\">values</span><span class=\"p\">)</span>\n    <span class=\"n\">user_repo</span><span class=\"p\">.</span><span class=\"nf\">create</span><span class=\"p\">(</span><span class=\"n\">values</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n<p>Here <code>CreateUser</code> is not linked to a dependency resolution implementation in any way. To provide the dependency, add a handler:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"kp\">include</span> <span class=\"no\">Dry</span><span class=\"o\">::</span><span class=\"no\">Effects</span><span class=\"o\">::</span><span class=\"no\">Handler</span><span class=\"o\">.</span><span class=\"no\">Resolve</span>\n\n<span class=\"n\">subject</span><span class=\"p\">(</span><span class=\"ss\">:create_user</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"no\">CreateUser</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"p\">}</span>\n\n<span class=\"n\">let</span><span class=\"p\">(</span><span class=\"ss\">:user_repo</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"n\">double</span><span class=\"p\">(</span><span class=\"ss\">:user_repo</span><span class=\"p\">,</span> <span class=\"ss\">create: </span><span class=\"o\">...</span><span class=\"p\">)</span> <span class=\"p\">}</span>\n\n<span class=\"n\">example</span> <span class=\"s1\">'creating a user'</span> <span class=\"k\">do</span>\n  <span class=\"n\">provide</span><span class=\"p\">(</span><span class=\"ss\">user_repo: </span><span class=\"n\">user_repo</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"n\">create_user</span><span class=\"o\">.</span><span class=\"p\">(</span><span class=\"o\">...</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n<p>You can provide multiple dependencies:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"n\">provide</span><span class=\"p\">(</span><span class=\"ss\">user_repo: </span><span class=\"n\">user_repo</span><span class=\"p\">,</span> <span class=\"ss\">post_repo: </span><span class=\"n\">post_repo</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"o\">...</span> <span class=\"p\">}</span>\n</code></pre></div>\n<p>Handlers are also composable, you can nest them:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"n\">provide</span><span class=\"p\">(</span><span class=\"ss\">user_repo: </span><span class=\"n\">user_repo</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"n\">provide</span><span class=\"p\">(</span><span class=\"ss\">post_repo: </span><span class=\"n\">post_repo</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"o\">...</span> <span class=\"p\">}</span> <span class=\"p\">}</span>\n</code></pre></div>\n<p>This is not limited to handlers of the same type:</p>\n<div class=\"highlight\"><pre class=\"syntax ruby\"><code><span class=\"n\">provide</span><span class=\"p\">(</span><span class=\"ss\">user_repo: </span><span class=\"n\">user_repo</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"n\">with_current_time</span> <span class=\"p\">{</span> <span class=\"o\">...</span> <span class=\"p\">}</span> <span class=\"p\">}</span>\n</code></pre></div>\n<p>Generally, effects and handlers work just the way you would expect; this is the most appealing thing about them (judging from experience!).</p>\n<h2 id=\"why-dry-effects\" class=\"hd\"><a name=\"why-dry-effects\" class=\"anchor\" href=\"#why-dry-effects\">            \n</a>Why dry-effects?</h2>\n<p>These are early days for algebraic effects. We believe they have a prominent future. The concept comes from the functional world and, since dry-rb heavily leans toward functional programming, it perfectly fits our ecosystem. There is no existing production-ready library for Ruby, that's why we've built our own.</p>\n\n<p>This post has mostly demonstrated using effects in application code, but they can be as easily used in libraries, providing a new level of flexibility to the users. This part is yet to be explored.</p>\n<h2 id=\"with-infinite-power-comes-infinite-responsibility\" class=\"hd\"><a name=\"with-infinite-power-comes-infinite-responsibility\" class=\"anchor\" href=\"#with-infinite-power-comes-infinite-responsibility\">            \n</a>With infinite power comes infinite responsibility</h2>\n<p>Algebraic effects are quite new, and as a community we have zero to little experience in using them. They may help you with writing clean, decoupled, and testable code, but they can also turn your app into unmaintainable mess, drop your database, and burn your house, so please be careful!</p>\n\n<p>As we gather experience, together we'll figure out what's good and what's bad. So please try it, and share what you learn with others!</p>\n<h2 id=\"dive-in\" class=\"hd\"><a name=\"dive-in\" class=\"anchor\" href=\"#dive-in\">            \n</a>Dive in!</h2>\n<p>The first version of dry-effects is already on <a href=\"https://rubygems.org/gems/dry-effects\">RubyGems.org</a>, go grab it. We have <a href=\"https://dry-rb.org/gems/dry-effects/0.1\">docs</a> for most effects and specs for all of them. As always, share your experience and ask your questions in our <a href=\"https://dry-rb.zulipchat.com\">chat</a> and at our <a href=\"https://discourse.dry-rb.org/\">forum</a>.</p>\n"
}