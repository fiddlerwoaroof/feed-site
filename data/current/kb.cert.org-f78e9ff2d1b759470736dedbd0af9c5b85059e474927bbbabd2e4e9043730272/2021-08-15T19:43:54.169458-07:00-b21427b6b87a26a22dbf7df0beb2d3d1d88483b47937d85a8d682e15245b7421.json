{
  "title":"VU#131152: Microsoft Windows Print Spooler Point and Print allows installation of arbitrary queue-specific files",
  "date":"2021-08-15T19:43:54.169458-07:00",
  "author":null,
  "id":"https://kb.cert.org/vuls/id/131152",
  "link":"https://kb.cert.org/vuls/id/131152",
  "content":"\n\n<div class=\"row\" id=\"content\">\n  <div class=\"large-9 medium-9 columns\">\n    <div class=\"blog-post\">\n      <div class=\"row\">\n        <div class=\"large-12 columns\">\n\t  \n\t  <h3>Overview</h3>\n<p>Microsoft Windows allows for non-admin users to be able to install printer drivers via Point and Print. Printers installed via this technique also install queue-specific files, which can be arbitrary libraries to be loaded by the privileged Windows Print Spooler process.</p>\n<h3>Description</h3>\n<p>Microsoft Windows allows for users who lack administrative privileges to still be able to install printer drivers, which execute with <code>SYSTEM</code> privileges via the Print Spooler service. This ability is achieved through a capability called <a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/print/introduction-to-point-and-print\">Point and Print</a>. Starting with the update for <a href=\"https://docs.microsoft.com/en-us/security-updates/securitybulletins/2016/ms16-087\">MS16-087</a>, Microsoft requires that printers installable via Point are either signed by a <a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/install/whql-release-signature\">WHQL release signature</a>, or are signed by a certificate that is explicitly trusted by the target system, such as an installed test signing certificate. The intention for this change is to avoid installation of malicious printer drivers, which can allow for Local Privilege Escalation (LPE) to <code>SYSTEM</code>.</p>\n<p>While Windows enforces that driver packages themselves are signed by a trusted source, Windows printer drivers can specify <a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/print/installing-queue-specific-files\">queue-specific files</a> that are associated with the use of the device. For example, a shared printer can specify a <code>CopyFiles</code> directive for arbitrary files. These files, which may be copied over alongside the digital-signature-enforced printer driver files are <strong>not</strong> covered by any signature requirement. Furthermore, these files can be used to overwrite any of the signature-verified files that were placed on a system during printer driver install. The remote printer can also be configured to automatically execute code in any files dropped by the <code>CopyFiles</code> directive. This can allow for LPE to <code>SYSTEM</code> on a vulnerable system.</p>\n<p>An exploit for this vulnerability is <a href=\"https://twitter.com/gentilkiwi/status/1416429860566847490\">publicly available</a>.</p>\n<h3>Impact</h3>\n<p>By connecting to a malicious printer, an attacker may be able to execute arbitrary code with <code>SYSTEM</code> privileges on a vulnerable system.</p>\n<h3>Solution</h3>\n<p>Microsoft has published <a href=\"https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36958\">CVE-2021-36958</a> about this issue. The CERT/CC is currently unaware of a practical solution to this problem. Please consider the following workarounds:</p>\n<h4>Block outbound SMB traffic at your network boundary</h4>\n<p>Public exploits for this vulnerability utilize SMB for connectivity to a malicious shared printer. If outbound connections to SMB resources are blocked, then this vulnerability may be mitigated for malicious SMB printers that are hosted outside of your network. Note that an attacker local to your network would be able to share a printer via SMB, which would be unaffected by any outbound SMB traffic rules.</p>\n<h4>Configure both PackagePointAndPrintServerList and PackagePointAndPrintOnly settings</h4>\n<p>Microsoft Windows has a Group Policy called &quot;Package Point and Print - Approved servers&quot;, which is reflected in the <code>HKLM\\Software\\Policies\\Microsoft\\Windows NT\\Printers\\PackagePointAndPrint\\PackagePointAndPrintServerList</code> and <code>HKLM\\Software\\Policies\\Microsoft\\Windows NT\\Printers\\PackagePointAndPrint\\ListofServers</code> registry values. This policy can restrict which servers can be used by non-administrative users to install printers via Point and Print. Configure this policy to prevent installation of printers from arbitrary servers.</p>\n<p>To ensure that Microsoft Windows only attempts to install Package Point and Print printers, and therefore restricting printer connections to the approved servers list, you must also set the <code>HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Printers\\PackagePointAndPrint\\PackagePointAndPrintOnly</code> registry value to <code>1</code>. The Group Policy setting that corresponds to this value is called &quot;Use only Package Point and print&quot;. Setting this value to &quot;Enabled&quot; will enforce that only Package Point and Print printers will be used.</p>\n<p><strong>Both</strong> of these settings must be configured to protect against exploitation of this vulnerability.</p>\n<h4>Block the ability to modify the print spooler drivers directory</h4>\n<p>Courtesy of the <a href=\"https://blog.truesec.com/2021/06/30/fix-for-printnightmare-cve-2021-1675-exploit-to-keep-your-print-servers-running-while-a-patch-is-not-available/\">TRUESEC Blog</a>, this vulnerability can be mitigated by preventing the <code>SYSTEM</code> account from being able to modify the <code>C:\\Windows\\System32\\spool\\drivers</code> directory contents.</p>\n<p>To enable this mitigation, from a privileged PowerShell session, run:</p>\n<pre><code>$Path = &quot;C:\\Windows\\System32\\spool\\drivers&quot;\n$Acl = (Get-Item $Path).GetAccessControl('Access')\n$Ar = New-Object  System.Security.AccessControl.FileSystemAccessRule(&quot;System&quot;, &quot;Modify&quot;, &quot;ContainerInherit, ObjectInherit&quot;, &quot;None&quot;, &quot;Deny&quot;)\n$Acl.AddAccessRule($Ar)\nSet-Acl $Path $Acl\n</code></pre>\n\n<p>To revert the mitigation to allow printer driver installation or modification, run:</p>\n<pre><code>$Path = &quot;C:\\Windows\\System32\\spool\\drivers&quot;\n$Acl = (Get-Item $Path).GetAccessControl('Access')\n$Ar = New-Object System.Security.AccessControl.FileSystemAccessRule(&quot;System&quot;, &quot;Modify&quot;, &quot;ContainerInherit, ObjectInherit&quot;, &quot;None&quot;, &quot;Deny&quot;)\n$Acl.RemoveAccessRule($Ar)\nSet-Acl $Path $Acl\n</code></pre>\n\n<h4>Stop and disable the Print Spooler</h4>\n<p>The Print Spooler can be disabled in a privileged PowerShell session by running the following commands:</p>\n<pre><code>Stop-Service -Name Spooler -Force\nSet-Service -Name Spooler -StartupType Disabled\n</code></pre>\n\n<p><strong>Impact of workaround</strong> Disabling the Print Spooler service disables the ability to print both locally and remotely.</p>\n<h3>Acknowledgements</h3>\n<p>This vulnerability was publicly disclosed by Benjamin Delpy. Microsoft credits Victor Mata with reporting this issue to them.</p>\n<p>This document was written by Will Dormann.</p>\n\t  \n\t</div>\n      </div>\n      <div class=\"row\">\n\t<div class=\"large-12 columns\">\n\t  <h3> Vendor Information </h3>\n\t  \n\t  <div id=\"vendorinfo\">\n\t    One or more vendors are listed for this advisory. Please reference the full report for more information.\n\t  </div>\n\t  \n\t</div>\n      </div>\n      <br>\n      \n      \n      <div class=\"row\">\n\t<div class=\"large-12 columns\">\n\t  <h3> References </h3>\n\t  <ul>\n\t    \n\t  \n\t  <li><a href=\"https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36958\" class=\"vulreflink\" rel=\"noopener\">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36958</a></li>\n          \n\t  <li><a href=\"https://docs.microsoft.com/en-us/security-updates/securitybulletins/2016/ms16-087\" class=\"vulreflink\" rel=\"noopener\">https://docs.microsoft.com/en-us/security-updates/securitybulletins/2016/ms16-087</a></li>\n          \n\t  <li><a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/print/introduction-to-point-and-print\" class=\"vulreflink\" rel=\"noopener\">https://docs.microsoft.com/en-us/windows-hardware/drivers/print/introduction-to-point-and-print</a></li>\n          \n\t  <li><a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/install/whql-release-signature\" class=\"vulreflink\" rel=\"noopener\">https://docs.microsoft.com/en-us/windows-hardware/drivers/install/whql-release-signature</a></li>\n          \n\t  <li><a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/print/installing-queue-specific-files\" class=\"vulreflink\" rel=\"noopener\">https://docs.microsoft.com/en-us/windows-hardware/drivers/print/installing-queue-specific-files</a></li>\n          \n\t  <li><a href=\"https://twitter.com/gentilkiwi/status/1416429860566847490\" class=\"vulreflink\" rel=\"noopener\">https://twitter.com/gentilkiwi/status/1416429860566847490</a></li>\n          \n\t  <li><a href=\"https://blog.truesec.com/2021/06/30/fix-for-printnightmare-cve-2021-1675-exploit-to-keep-your-print-servers-running-while-a-patch-is-not-available/\" class=\"vulreflink\" rel=\"noopener\">https://blog.truesec.com/2021/06/30/fix-for-printnightmare-cve-2021-1675-exploit-to-keep-your-print-servers-running-while-a-patch-is-not-available/</a></li>\n          \n\t  \n\t  </ul>\n\t</div>\n      </div>\n      \n      <h3>Other Information</h3>\n        <div class=\"vulcontent\">\n          <table class=\"unstriped\">\n            <tbody>\n\t      \n              <tr>\n                <td width=\"200\"><b>CVE IDs:</b></td>\n\t\t<td>\n\t\t\n\t\t\n                <a href=\"http://web.nvd.nist.gov/view/vuln/detail?vulnId=2021-36958\">CVE-2021-36958  </a>\n\t\t\n                \n\t\t</td>\n\t      </tr>\n\t      \n\t      <tr>\n\t\t<td>\n\t\t  <b>Date Public:</b>\n\t\t</td>\n                <td>2021-07-18</td>\n              </tr>\n              <tr>\n                <td><b>Date First Published:</b></td>\n                <td id=\"datefirstpublished\">2021-07-18</td>\n              </tr>\n              <tr>\n                <td><b>Date Last Updated: </b></td>\n                <td>2021-08-16 02:43 UTC</td>\n              </tr>\n              <tr>\n                <td><b>Document Revision: </b></td>\n                <td>16 </td>\n              </tr>\n            </tbody>\n          </table>\n\t</div>\n    </div>\n  </div>\n  <div class=\"large-3 medium-3 columns\">\n  <div class=\"sticky\">\n    <div class=\"sidebar-links\">\n      <ul class=\"menu vertical\">\n\t<li><a href=\"https://vuls.cert.org/confluence/display/VIN/Vulnerability+Note+Help\" rel=\"noopener\">About vulnerability notes</a></li>\n\t<li><a href=\"mailto:cert@cert.org?Subject=VU%23131152 Feedback\">Contact us about this vulnerability</a></li>\n\t<li><a href=\"https://vuls.cert.org/confluence/display/VIN/Case+Handling#CaseHandling-Givingavendorstatusandstatement\">Provide a vendor statement</a></li>\n      </ul>\n    </div>\n  </div>\n</div>\n\n</div>\n\n\n\n"
}