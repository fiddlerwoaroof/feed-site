{
  "title":"VU#434994: Multiple race conditions due to TOCTOU flaws in various UEFI Implementations",
  "date":"2022-11-11T15:44:06.591204Z",
  "author":null,
  "id":"https://kb.cert.org/vuls/id/434994",
  "link":"https://kb.cert.org/vuls/id/434994",
  "content":"\n\n<div class=\"row\" id=\"content\">\n  <div class=\"large-9 medium-9 columns\">\n    <div class=\"blog-post\">\n      <div class=\"row\">\n        <div class=\"large-12 columns\">\n\t  \n\t  <h3 id=\"overview\">Overview</h3>\n<p>Multiple Unified Extensible Firmware Interface (UEFI) implementations are vulnerable to code execution in System Management Mode (SMM) by an attacker who gains administrative privileges on the local machine. An attacker can corrupt the memory using Direct Memory Access (DMA) timing attacks that can lead to code execution. These threats are collectively referred to as RingHopper attacks.</p>\n<h3 id=\"description\">Description</h3>\n<p>The UEFI standard provides an open specification that defines a software interface between an operating system (OS) and the device hardware on the system.  UEFI can interface directly with hardware below the OS using SMM, a high-privilege CPU mode.  <a href=\"https://edk2-docs.gitbook.io/edk-ii-secure-coding-guide/secure_coding_guidelines_intel_platforms/smm\">SMM operations</a> are closely managed by the CPU using a dedicated portion of memory called the SMRAM.  The SMM can only be entered through System Management Interrupt (SMI) Handlers using a communication buffer.  SMI Handlers are essentially a system-call to access the CPU's SMRAM from its current operating mode, typically Protected Mode.</p>\n<p>A race condition involving the access and validation of the SMRAM can be achieved using DMA timing attacks that rely on time-of-use (<a href=\"https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use\">TOCTOU</a>) conditions. An attacker can use well-timed probing to try and overwrite the contents of SMRAM with arbitrary data, leading to attacker code being executed with the same elevated-privileges available to the CPU (i.e., <a href=\"https://en.wikipedia.org/wiki/System_Management_Mode\">Ring -2 mode</a>).  The asynchronous nature of SMRAM access via DMA controllers enables the attacker to perform such unauthorized access and bypass the verifications normally provided by the SMI Handler API.  </p>\n<p>The Intel-VT and Intel VT-d technologies provide some protection against DMA attacks using Input-Output Memory Management Unit (IOMMU) to address DMA threats.  Although IOMMU can protect from DMA hardware attacks, SMI Handlers vulnerable to RingHopper may still be abused.  SMRAM verification involving <a href=\"https://www.sentinelone.com/labs/another-brick-in-the-wall-uncovering-smm-vulnerabilities-in-hp-firmware/\">validation of nested pointers</a> adds even more complexity when analyzing how various SMI Handlers are used in UEFI. </p>\n<h3 id=\"impact\">Impact</h3>\n<p>An attacker with either local or remote administrative privileges can exploit DMA timing attacks to elevate privileges beyond the operating system and execute arbitrary code in SMM mode (Ring -2). These attacks can be invoked from the OS using vulnerable SMI Handlers.  In some cases, the vulnerabilities can be triggered in the UEFI early boot phases (as well as sleep and recovery) before the operating system is fully initialized.</p>\n<p>A successful attack enables any of the following impacts:</p>\n<ul>\n<li>Invalidation or bypass of UEFI security features (SecureBoot, Intel BootGuard).</li>\n<li>Installation of persistent software that cannot be easily detected or erased.</li>\n<li>Creation of backdoors and back communications channels to exfiltrate sensitive data</li>\n<li>Interruption of system execution leading to permanent shutdown.</li>\n</ul>\n<p>Because these attacks are against UEFI supported firmware, OS and EDR solutions may have diminished visibility into unauthorized access.</p>\n<h3 id=\"solution\">Solution</h3>\n<p>Install the latest stable version of UEFI firmware provided by your PC vendor or by the reseller of your computing environments. See the links below for resources and updates provided by specific vendors to address these issues.  </p>\n<p>If your operating system supports automatic or managed updates for firmware, such as Linux Vendor Firmware Service (<a href=\"https://fwupd.org/lvfs/docs/users\">LVFS</a>), check (<code>fwupdmgr get-updates</code>) and apply the firmware updates provided by LVFS using <code>fwupdmgr update</code> as appropriate. </p>\n<h3 id=\"acknowledgements\">Acknowledgements</h3>\n<p>Thanks to the Intel iStare researchers Jonathan Lusky  and Benny Zeltser who discovered and reported this vulnerability. </p>\n<p>This document was written by Vijay Sarvepalli and Jeffrey S. Havrilla.</p>\n\t  \n\t</div>\n      </div>\n      <div class=\"row\">\n\t<div class=\"large-12 columns\">\n\t  <h3> Vendor Information </h3>\n\t  \n\t  <div id=\"vendorinfo\">\n\t    One or more vendors are listed for this advisory. Please reference the full report for more information.\n\t  </div>\n\t  \n\t</div>\n      </div>\n      <br>\n      \n      \n      <div class=\"row\">\n\t<div class=\"large-12 columns\">\n\t  <h3> References </h3>\n\t  <ul>\n\t    \n\t    \n\t    \n            <li><a href=\"https://edk2-docs.gitbook.io/edk-ii-secure-coding-guide/secure_coding_guidelines_general\" class=\"vulreflink safereflink\" rel=\"noopener\">https://edk2-docs.gitbook.io/edk-ii-secure-coding-guide/secure_coding_guidelines_general</a></li>\n            \n          \n\t    \n            <li><a href=\"https://edk2-docs.gitbook.io/a-tour-beyond-bios-memory-protection-in-uefi-bios/memory-protection-in-smm\" class=\"vulreflink safereflink\" rel=\"noopener\">https://edk2-docs.gitbook.io/a-tour-beyond-bios-memory-protection-in-uefi-bios/memory-protection-in-smm</a></li>\n            \n          \n\t    \n            <li><a href=\"https://eclypsium.com/2020/01/30/direct-memory-access-attacks/\" class=\"vulreflink safereflink\" rel=\"noopener\">https://eclypsium.com/2020/01/30/direct-memory-access-attacks/</a></li>\n            \n          \n\t    \n            <li><a href=\"https://www.intel.com/content/dam/develop/external/us/en/documents/intel-whitepaper-using-iommu-for-dma-protection-in-uefi-820238.pdf\" class=\"vulreflink safereflink\" rel=\"noopener\">https://www.intel.com/content/dam/develop/external/us/en/documents/intel-whitepaper-using-iommu-for-dma-protection-in-uefi-820238.pdf</a></li>\n            \n          \n\t    \n            <li><a href=\"http://blog.cr4.sh/2015/09/breaking-uefi-security-with-software.html\" class=\"vulreflink safereflink\" rel=\"noopener\">http://blog.cr4.sh/2015/09/breaking-uefi-security-with-software.html</a></li>\n            \n          \n\t    \n            <li><a href=\"https://www.sentinelone.com/labs/another-brick-in-the-wall-uncovering-smm-vulnerabilities-in-hp-firmware/\" class=\"vulreflink safereflink\" rel=\"noopener\">https://www.sentinelone.com/labs/another-brick-in-the-wall-uncovering-smm-vulnerabilities-in-hp-firmware/</a></li>\n            \n          \n\t    \n            <li><a href=\"https://fwupd.org/lvfs/docs/users\" class=\"vulreflink safereflink\" rel=\"noopener\">https://fwupd.org/lvfs/docs/users</a></li>\n            \n          \n\t    \n            <li><a href=\"https://jvn.jp/vu/JVNVU96604488/\" class=\"vulreflink safereflink\" rel=\"noopener\">https://jvn.jp/vu/JVNVU96604488/</a></li>\n            \n          \n\t  \n\t  </ul>\n\t</div>\n      </div>\n      \n      <h3>Other Information</h3>\n        <div class=\"vulcontent\">\n          <table class=\"unstriped\">\n            <tbody>\n\t      \n              <tr>\n                <td width=\"200\"><b>CVE IDs:</b></td>\n\t\t<td>\n\t\t\n\t\t\n                <a href=\"http://web.nvd.nist.gov/view/vuln/detail?vulnId=2021-33164\">CVE-2021-33164  </a>\n\t\t\n                \n\t\t</td>\n\t      </tr>\n\t      \n\t      <tr>\n\t\t<td>\n\t\t  <b>Date Public:</b>\n\t\t</td>\n                <td>2022-11-08</td>\n              </tr>\n              <tr>\n                <td><b>Date First Published:</b></td>\n                <td id=\"datefirstpublished\">2022-11-08</td>\n              </tr>\n              <tr>\n                <td><b>Date Last Updated: </b></td>\n                <td>2022-11-11 15:44 UTC</td>\n              </tr>\n              <tr>\n                <td><b>Document Revision: </b></td>\n                <td>5 </td>\n              </tr>\n            </tbody>\n          </table>\n\t</div>\n    </div>\n  </div>\n  <div class=\"large-3 medium-3 columns\">\n  <div class=\"sticky\">\n    <div class=\"sidebar-links\">\n      <ul class=\"menu vertical\">\n\t<li><a href=\"https://vuls.cert.org/confluence/display/VIN/Vulnerability+Note+Help\" rel=\"noopener\">About vulnerability notes</a></li>\n\t<li><a href=\"mailto:cert@cert.org?Subject=VU%23434994 Feedback\">Contact us about this vulnerability</a></li>\n\t<li><a href=\"https://vuls.cert.org/confluence/display/VIN/Case+Handling#CaseHandling-Givingavendorstatusandstatement\">Provide a vendor statement</a></li>\n      </ul>\n    </div>\n  </div>\n</div>\n\n</div>\n\n\n\n"
}