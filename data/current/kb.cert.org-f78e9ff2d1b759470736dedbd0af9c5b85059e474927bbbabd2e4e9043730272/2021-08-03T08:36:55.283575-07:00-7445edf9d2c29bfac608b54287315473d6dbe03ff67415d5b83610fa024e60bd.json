{
  "title":"VU#383432: Microsoft Windows Print Spooler allows for RCE via AddPrinterDriverEx()",
  "date":"2021-08-03T08:36:55.283575-07:00",
  "author":null,
  "id":"https://kb.cert.org/vuls/id/383432",
  "link":"https://kb.cert.org/vuls/id/383432",
  "content":"\n\n<div class=\"row\" id=\"content\">\n  <div class=\"large-9 medium-9 columns\">\n    <div class=\"blog-post\">\n      <div class=\"row\">\n        <div class=\"large-12 columns\">\n\t  \n\t  <h3>Overview</h3>\n<p>The Microsoft Windows Print Spooler service fails to restrict access to functionality that allows users to add printers and related drivers, which can allow a remote authenticated attacker to execute arbitrary code with SYSTEM privileges on a vulnerable system.</p>\n<h3>Description</h3>\n<p>The <a href=\"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/b96cc497-59e5-4510-ab04-5484993b259b\">RpcAddPrinterDriverEx()</a> function is used to install a printer driver on a system. One of the parameters to this function is the <a href=\"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/353ff796-6fb3-41cf-8b35-0022dd53d886\">DRIVER_CONTAINER</a> object, which contains information about which driver is to be used by the added printer. The other argument, <code>dwFileCopyFlags</code>, specifies how replacement printer driver files are to be copied. An attacker can take advantage of the fact that any authenticated user can call <code>RpcAddPrinterDriverEx()</code> and specify a driver file that lives on a remote server. This results in the Print Spooler service <code>spoolsv.exe</code> executing code in an arbitrary DLL file with SYSTEM privileges.</p>\n<p>Note that while original exploit code relied on the <code>RpcAddPrinterDriverEx</code> to achieve code execution, <a href=\"https://github.com/cube0x0/CVE-2021-1675\">an updated version of the exploit</a> uses <a href=\"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-par/5d864e3e-5d8b-4337-89ce-cb0258ab97cd\">RpcAsyncAddPrinterDriver</a> to achieve the same goal. Both of these functions achieve their functionality using <a href=\"https://docs.microsoft.com/en-us/windows/win32/printdocs/addprinterdriverex\">AddPrinterDriverEx</a>.</p>\n<p>While Microsoft has released an <a href=\"https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675\">update for CVE-2021-1675</a>, it is important to realize that this update does <strong>NOT</strong> protect against public exploits that may refer to <code>PrintNightmare</code> or CVE-2021-1675.</p>\n<p>On July 1, Microsoft released <a href=\"https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527\">CVE-2021-34527</a>. This bulletin states that CVE-2021-34527 is similar but distinct from the vulnerability that is assigned CVE-2021-1675, which addresses a different vulnerability in RpcAddPrinterDriverEx(). The attack vector is different as well. CVE-2021-1675 was addressed by the June 2021 security update. </p>\n<h3>Impact</h3>\n<p>By sending a request to add a printer, e.g. by using <code>RpcAddPrinterDriverEx()</code> over SMB or <code>RpcAsyncAddPrinterDriver()</code> over RPC, a remote, authenticated attacker may be able to execute arbitrary code with SYSTEM privileges on a vulnerable system. A local unprivileged user may be able to execute arbitrary code with SYSTEM privileges as well. We have created a flowchart to indicate exploitability of PrintNightmare across various platform configurations:</p>\n<p><a href=\"/static-bigvince-prod-kb-eb/383432_PrintNightmare%20Flowchart-v9.png\"><img alt=\"PrintNightmare exploitability flowchart\" src=\"/static-bigvince-prod-kb-eb/383432_PrintNightmare%20Flowchart-v9.png\"></a></p>\n<h3>Solution</h3>\n<h4>Apply an update</h4>\n<p>Microsoft has addressed this issue in the <a href=\"https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527\">updates for CVE-2021-34527</a>. Note that the Microsoft update for CVE-2021-34527 does not effectively prevent exploitation of systems where the <a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/print/introduction-to-point-and-print\">Point and Print</a> <code>NoWarningNoElevationOnInstall</code> is set to a non-<code>0</code> value. Microsoft indicates that systems that have <code>NoWarningNoElevationOnInstall</code> is set to a non-<code>0</code> value are <strong>vulnerable by design.</strong> For systems that do not have the CVE-2021-34527 installed, or have Point and Print configured insecurely, please consider the following workarounds:</p>\n<h4>Apply a workaround</h4>\n<p>Microsoft has listed several workarounds in their <a href=\"https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527\">advisory for CVE-2021-34527</a>. Specifically:</p>\n<h4>Microsoft Option 1 - Stop and disable the Print Spooler service</h4>\n<p>This vulnerability can be mitigated by stopping and disabling the Print Spooler service in Windows.</p>\n<p>If disabling the Print Spooler service is appropriate for your enterprise, use the following PowerShell commands:</p>\n<p><code>Stop-Service -Name Spooler -Force</code></p>\n<p><code>Set-Service -Name Spooler -StartupType Disabled</code></p>\n<p><strong>Impact of workaround</strong> Disabling the Print Spooler service disables the ability to print both locally and remotely.</p>\n<h4>Microsoft Option 2 - Disable inbound remote printing through Group Policy</h4>\n<p>Disable the “Allow Print Spooler to accept client connections:” policy to block remote attacks.</p>\n<p><strong>Impact of workaround</strong> This policy will block the remote attack vector by preventing inbound remote printing operations. The system will no longer function as a print server, but local printing to a directly attached device will still be possible.</p>\n<p><strong>Note:</strong> The Print Spooler service <strong>must</strong> be restarted for this workaround to be activated.</p>\n<h4>Block RPC and SMB ports at the firewall</h4>\n<p>Limited testing has shown that blocking both the RPC Endpoint Mapper (<code>135/tcp</code>) and SMB (<code>139/tcp</code> and <code>445/tcp</code>) incoming traffic at a host-based firewall level can prevent remote exploitation of this vulnerability. Note that blocking these ports on a Windows system may prevent expected capabilities from functioning properly, especially on a system that functions as a server.</p>\n<h4>Enable security prompts for Point and Print</h4>\n<p>Ensure that the Windows Point and Print Restrictions are set to <code>Show warning and elevation prompt</code> for both installing and updating drivers in the Windows Group Policy. Specifically the <code>HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Printers\\PointAndPrint\\</code> key should have <code>NoWarningNoElevationOnInstall</code> and <code>UpdatePromptSettings</code> entries that are both set to <code>0</code>.</p>\n<h4>Restrict printer driver installation ability to administrators</h4>\n<p>After the Microsoft update for CVE-2021-34527 is installed, a registry value called <code>RestrictDriverInstallationToAdministrators</code> in the <code>HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Printers\\PointAndPrint\\</code> key is checked, which is intended to restrict printer driver installation to only administrator users. Please see <a href=\"https://support.microsoft.com/en-us/topic/kb5005010-restricting-installation-of-new-printer-drivers-after-applying-the-july-6-2021-updates-31b91c02-05bc-4ada-a7ea-183b129578a7\">KB5005010</a> for more details.</p>\n<h3>Acknowledgements</h3>\n<p>This issue was publicly disclosed by Zhiniang Peng and Xuefeng Li.</p>\n<p>This document was written by Will Dormann.</p>\n\t  \n\t</div>\n      </div>\n      <div class=\"row\">\n\t<div class=\"large-12 columns\">\n\t  <h3> Vendor Information </h3>\n\t  \n\t  <div id=\"vendorinfo\">\n\t    One or more vendors are listed for this advisory. Please reference the full report for more information.\n\t  </div>\n\t  \n\t</div>\n      </div>\n      <br>\n      \n      \n      <div class=\"row\">\n\t<div class=\"large-12 columns\">\n\t  <h3> References </h3>\n\t  <ul>\n\t    \n\t  \n\t  <li><a href=\"https://msrc-blog.microsoft.com/2021/07/08/clarified-guidance-for-cve-2021-34527-windows-print-spooler-vulnerability/\" class=\"vulreflink\" rel=\"noopener\">https://msrc-blog.microsoft.com/2021/07/08/clarified-guidance-for-cve-2021-34527-windows-print-spooler-vulnerability/</a></li>\n          \n\t  <li><a href=\"https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675\" class=\"vulreflink\" rel=\"noopener\">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675</a></li>\n          \n\t  <li><a href=\"https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527\" class=\"vulreflink\" rel=\"noopener\">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527</a></li>\n          \n\t  <li><a href=\"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/b96cc497-59e5-4510-ab04-5484993b259b\" class=\"vulreflink\" rel=\"noopener\">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/b96cc497-59e5-4510-ab04-5484993b259b</a></li>\n          \n\t  <li><a href=\"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/353ff796-6fb3-41cf-8b35-0022dd53d886\" class=\"vulreflink\" rel=\"noopener\">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/353ff796-6fb3-41cf-8b35-0022dd53d886</a></li>\n          \n\t  <li><a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/print/introduction-to-point-and-print\" class=\"vulreflink\" rel=\"noopener\">https://docs.microsoft.com/en-us/windows-hardware/drivers/print/introduction-to-point-and-print</a></li>\n          \n\t  <li><a href=\"https://docs.microsoft.com/en-us/windows/win32/printdocs/addprinterdriverex\" class=\"vulreflink\" rel=\"noopener\">https://docs.microsoft.com/en-us/windows/win32/printdocs/addprinterdriverex</a></li>\n          \n\t  <li><a href=\"https://support.microsoft.com/en-us/topic/kb5005010-restricting-installation-of-new-printer-drivers-after-applying-the-july-6-2021-updates-31b91c02-05bc-4ada-a7ea-183b129578a7\" class=\"vulreflink\" rel=\"noopener\">https://support.microsoft.com/en-us/topic/kb5005010-restricting-installation-of-new-printer-drivers-after-applying-the-july-6-2021-updates-31b91c02-05bc-4ada-a7ea-183b129578a7</a></li>\n          \n\t  <li><a href=\"https://github.com/afwu/PrintNightmare\" class=\"vulreflink\" rel=\"noopener\">https://github.com/afwu/PrintNightmare</a></li>\n          \n\t  <li><a href=\"https://github.com/cube0x0/CVE-2021-1675\" class=\"vulreflink\" rel=\"noopener\">https://github.com/cube0x0/CVE-2021-1675</a></li>\n          \n\t  <li><a href=\"https://github.com/calebstewart/CVE-2021-1675\" class=\"vulreflink\" rel=\"noopener\">https://github.com/calebstewart/CVE-2021-1675</a></li>\n          \n\t  \n\t  </ul>\n\t</div>\n      </div>\n      \n      <h3>Other Information</h3>\n        <div class=\"vulcontent\">\n          <table class=\"unstriped\">\n            <tbody>\n\t      \n              <tr>\n                <td width=\"200\"><b>CVE IDs:</b></td>\n\t\t<td>\n\t\t\n\t\t\n                <a href=\"http://web.nvd.nist.gov/view/vuln/detail?vulnId=2021-1675\">CVE-2021-1675  </a>\n\t\t\n                \n\t\t\n                <a href=\"http://web.nvd.nist.gov/view/vuln/detail?vulnId=2021-34527\">CVE-2021-34527  </a>\n\t\t\n                \n\t\t</td>\n\t      </tr>\n\t      \n\t      <tr>\n\t\t<td>\n\t\t  <b>Date Public:</b>\n\t\t</td>\n                <td>2021-06-30</td>\n              </tr>\n              <tr>\n                <td><b>Date First Published:</b></td>\n                <td id=\"datefirstpublished\">2021-06-30</td>\n              </tr>\n              <tr>\n                <td><b>Date Last Updated: </b></td>\n                <td>2021-08-03 15:36 UTC</td>\n              </tr>\n              <tr>\n                <td><b>Document Revision: </b></td>\n                <td>32 </td>\n              </tr>\n            </tbody>\n          </table>\n\t</div>\n    </div>\n  </div>\n  <div class=\"large-3 medium-3 columns\">\n  <div class=\"sticky\">\n    <div class=\"sidebar-links\">\n      <ul class=\"menu vertical\">\n\t<li><a href=\"https://vuls.cert.org/confluence/display/VIN/Vulnerability+Note+Help\" rel=\"noopener\">About vulnerability notes</a></li>\n\t<li><a href=\"mailto:cert@cert.org?Subject=VU%23383432 Feedback\">Contact us about this vulnerability</a></li>\n\t<li><a href=\"https://vuls.cert.org/confluence/display/VIN/Case+Handling#CaseHandling-Givingavendorstatusandstatement\">Provide a vendor statement</a></li>\n      </ul>\n    </div>\n  </div>\n</div>\n\n</div>\n\n\n\n"
}