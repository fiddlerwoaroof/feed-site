{
  "title":"VU#405600: Microsoft Windows Active Directory Certificate Services can allow for AD compromise via PetitPotam NTLM relay attacks",
  "date":"2021-08-17T12:03:32.205470-07:00",
  "author":null,
  "id":"https://kb.cert.org/vuls/id/405600",
  "link":"https://kb.cert.org/vuls/id/405600",
  "content":"\n\n<div class=\"row\" id=\"content\">\n  <div class=\"large-9 medium-9 columns\">\n    <div class=\"blog-post\">\n      <div class=\"row\">\n        <div class=\"large-12 columns\">\n\t  \n\t  <h3>Overview</h3>\n<p>Microsoft Windows Active Directory Certificate Services (AD CS) by default can be used as a target for NTLM relay attacks, which can allow a domain-joined computer to take over the entire Active Directory.</p>\n<h3>Description</h3>\n<p><a href=\"https://github.com/topotam/PetitPotam\">PetitPotam</a> is a tool to force Windows hosts to authenticate to other machines by using the <a href=\"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr\">Encrypting File System Remote (EFSRPC)</a> <a href=\"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/ccc4fb75-1c86-41d7-bbc4-b278ec13bfb8\">EfsRpcOpenFileRaw</a> and other methods. When a system handles certain EFSRPC requests, it will by default use NTLM to authenticate with the host that is specified within the path to the file specified in the EFSRPC request. The user specified in the NTLM authentication information is the computer account of the machine that made the EFSRPC request.</p>\n<p>Code running on any domain-joined system will leverage Single Sign-On (SSO) to call these EFSRPC functions on a domain controller without needing to know the credentials of the current user or any other user in an Active Directory. And because the EFSRPC methods authenticate as the machine dispatching the request, this means that a user of any system connected to an AD domain can trigger an NTLM authentication request as the domain controller machine account to an arbitrary host, without needing to know any credentials. This can allow for NTLM relay attacks. Furthermore, the <code>EfsRpcOpenFileRaw</code> function can be invoked in a truly anonymous manner, without requiring credentials via SSO or other means.</p>\n<p>One publicly-discussed target for an NTLM relay attack from a domain controller is a machine that hosts <a href=\"https://docs.microsoft.com/en-us/windows-server/networking/core-network-guide/cncg/server-certs/install-the-certification-authority\">Microsoft AD CS</a>. By relaying an NTLM authentication request from a domain controller to the Certificate Authority Web Enrollment or the Certificate Enrollment Web Service on an AD CS system, an attacker can obtain a certificate that can be used to obtain a Ticket Granting Ticket (TGT) from the domain controller. This attack, known as a &quot;Golden Ticket&quot; attack, can be used to fully compromise the entire Active Directory infrastructure.</p>\n<p>Although Microsoft refers to this entire attack chain as &quot;PetitPotam&quot; in <a href=\"https://support.microsoft.com/en-us/topic/kb5005413-mitigating-ntlm-relay-attacks-on-active-directory-certificate-services-ad-cs-3612b773-4043-4aa9-b23d-b87910cd3429\">KB5005413</a>, it is important to realize that PetitPotam is simply the single PoC exploit used to invoke an NTLM authentication request by way of a <code>EfsRpcOpenFileRaw</code> request. It should be noted that:</p>\n<ol>\n<li>There may be other techniques that may cause a Windows system to initiate a connection to an arbitrary host using privileged NTLM credentials.</li>\n<li>There may be services other than AD CS that may be leveraged to use as a target for a relayed NTLM authentication request.</li>\n</ol>\n<h3>Impact</h3>\n<p>By making a crafted RPC request to a vulnerable Windows system, a remote attacker may be able to leverage the NTLM authentication information that is included in the request that is generated. In the case of AD CS, this can allow an attacker on any domain-joined system to be able to compromise the Active Directory.</p>\n<h3>Solution</h3>\n<h4>Apply an update</h4>\n<p>This issue is partially addressed in the <a href=\"https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-36942\">Microsoft update for CVE-2021-36942</a>. This update blocks the unauthenticated <code>EfsRpcOpenFileRaw</code> API call that is exposed through the LSARPC interface. Note that the EFSRPC interface for accessing <code>EfsRpcOpenFileRaw</code> is still reachable to authenticated users after installing this update. In addition, other EFSRPC functions that require authentication to exploit are still exposed to users via LSARPC after this update is installed. This required authentication may take place silently via SSO on domain-joined systems. Please see <a href=\"https://support.microsoft.com/en-us/topic/kb5005413-mitigating-ntlm-relay-attacks-on-active-directory-certificate-services-ad-cs-3612b773-4043-4aa9-b23d-b87910cd3429\">KB5005413</a> for several additional workarounds that can help mitigate other techniques for relaying NTLM credentials using an AD CS server.</p>\n<h4>Enable Extended Protection for Authentication (EPA) and Require SSL on AD CS systems</h4>\n<p>Please see <a href=\"https://support.microsoft.com/en-us/topic/kb5005413-mitigating-ntlm-relay-attacks-on-active-directory-certificate-services-ad-cs-3612b773-4043-4aa9-b23d-b87910cd3429\">KB5005413</a> for more details about enabling EPA to help protect against this weakness. It is important to note:</p>\n<ol>\n<li>In addition to configuring EPA through the IIS Manager GUI, the Certificate Enrollment Web Service (CES) also requires modifying the <code>web.config</code> file to successfully enable EPA.</li>\n<li>The CES and the CertSrv applications <strong>must</strong> be configured to enable the <strong>Require SSL</strong> option for EPA protection to work. If <strong>Require SSL</strong> is not enabled, then any changes to the EPA settings will not have any effect.</li>\n</ol>\n<h4>Disable incoming NTLM on AD CS servers</h4>\n<p>The stage of leveraging an AD CS server to achieve the ability to get a TGT can be mitigated by disabling incoming NTLM support on AD CS servers. To configure this GPO setting, go to:\n<strong>Configuration -&gt; Windows Settings -&gt; Security Settings -&gt; Local Policies -&gt; Security Options</strong>\nand set <strong>Network security: Restrict NTLM: Incoming NTLM traffic</strong> to <strong>Deny All Accounts</strong> or <strong>Deny All domain accounts</strong></p>\n<p>Note that the group policy may need to be refreshed on the AD CS server for this mitigation to take effect.</p>\n<h4>Disable the NTLM provider in IIS</h4>\n<p>For both the &quot;Certificate Authority Web Enrollment&quot; (CES) service (<code>&lt;CA_INFO&gt;-CA_CES_Kerberos</code> in IIS Manager) and the &quot;Certificate Enrollment Web Service&quot; (<code>CertSrv</code> in IIS Manager) services:</p>\n<ol>\n<li>Open IIS Manager</li>\n<li>Select Sites -&gt; Default Web Site (or another name if it was manually reconfigured) -&gt; <code>*-CA_CES_Kerberos</code>  and <code>CertSrv</code></li>\n<li>Select <code>Windows Authentication</code></li>\n<li>Click the <code>Providers...</code> link on the right side</li>\n<li>Select <code>NTLM</code></li>\n<li>Click the <code>Remove</code> Button</li>\n<li>Restart IIS from an Administrator CMD prompt: <code>iisreset /restart</code></li>\n</ol>\n<h4>Block [MS-ESFR] (EFSRPC) using RPC filters</h4>\n<p>RPC filters can be used to block the (remote) EFSRPC functionality that PetitPotam uses. This can be done by blocking the <a href=\"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/1baaad2f-7a84-4238-b113-f32827a39cd2\">RPC interface UUIDs for EFSRPC</a>.</p>\n<p>First create a file called <code>block_efsr.txt</code> and place the following contents in it:</p>\n<pre><code>rpc\nfilter\nadd rule layer=um actiontype=block\nadd condition field=if_uuid matchtype=equal data=c681d488-d850-11d0-8c52-00c04fd90f7e\nadd filter\nadd rule layer=um actiontype=block\nadd condition field=if_uuid matchtype=equal data=df1941c5-fe89-4e79-bf10-463657acf44d\nadd filter\nquit\n</code></pre>\n\n<p>Then import the filter using the following command from an elevated-privileged command prompt:<br>\n<code>netsh -f block_efsr.txt</code></p>\n<p>Alternatively, the above text block can be pasted into an interactive <code>netsh</code> session if you wish to avoid the use of a file to import the rules from.</p>\n<p>The current filters can be viewed by running the following command:<br>\n<code>netsh rpc filter show filter</code>.</p>\n<p>All RPC filters can be removed using the following command:<br>\n<code>netsh rpc filter delete filter filterkey=</code><br>\nThis will restore Windows to its default configuration of not having any RPC filters.  If you have other RPC filters in place and wish to remove only the EFSRPC filters, you can specify the specific <code>filterKey</code> values that are reported by the <code>show filter</code> command listed above.</p>\n<h4>Disable NTLM Authentication on your Windows domain controller</h4>\n<p>Instructions for disabling NTLM authentication in your domain can be found in the article <a href=\"https://docs.microsoft.com/windows/security/threat-protection/security-policy-settings/network-security-restrict-ntlm-ntlm-authentication-in-this-domain\">Network security: Restrict NTLM: NTLM authentication in this domain</a>.</p>\n<p>Note that existing logins may need to be terminated for this mitigation to take effect. Also note that disabling NTLM has been reported by some to be disruptive to expected network functionality. For this reason, please consider the other workarounds in this vulnerability note.</p>\n<h3>Acknowledgements</h3>\n<p>The PetitPotam aspect of this attack chain was publicly disclosed by topotam. The AD CS aspect was publicly disclosed by harmj0y (Will Schroeder) and tifkin_ (Lee Christensen).</p>\n<p>This document was written by Will Dormann.</p>\n\t  \n\t</div>\n      </div>\n      <div class=\"row\">\n\t<div class=\"large-12 columns\">\n\t  <h3> Vendor Information </h3>\n\t  \n\t  <div id=\"vendorinfo\">\n\t    One or more vendors are listed for this advisory. Please reference the full report for more information.\n\t  </div>\n\t  \n\t</div>\n      </div>\n      <br>\n      \n      \n      <div class=\"row\">\n\t<div class=\"large-12 columns\">\n\t  <h3> References </h3>\n\t  <ul>\n\t    \n\t  \n\t  <li><a href=\"https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-36942\" class=\"vulreflink\" rel=\"noopener\">https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-36942</a></li>\n          \n\t  <li><a href=\"https://msrc.microsoft.com/update-guide/vulnerability/ADV210003\" class=\"vulreflink\" rel=\"noopener\">https://msrc.microsoft.com/update-guide/vulnerability/ADV210003</a></li>\n          \n\t  <li><a href=\"https://support.microsoft.com/en-us/topic/kb5005413-mitigating-ntlm-relay-attacks-on-active-directory-certificate-services-ad-cs-3612b773-4043-4aa9-b23d-b87910cd3429\" class=\"vulreflink\" rel=\"noopener\">https://support.microsoft.com/en-us/topic/kb5005413-mitigating-ntlm-relay-attacks-on-active-directory-certificate-services-ad-cs-3612b773-4043-4aa9-b23d-b87910cd3429</a></li>\n          \n\t  <li><a href=\"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr\" class=\"vulreflink\" rel=\"noopener\">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr</a></li>\n          \n\t  <li><a href=\"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/ccc4fb75-1c86-41d7-bbc4-b278ec13bfb8\" class=\"vulreflink\" rel=\"noopener\">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/ccc4fb75-1c86-41d7-bbc4-b278ec13bfb8</a></li>\n          \n\t  <li><a href=\"https://docs.microsoft.com/en-us/windows-server/networking/core-network-guide/cncg/server-certs/install-the-certification-authority\" class=\"vulreflink\" rel=\"noopener\">https://docs.microsoft.com/en-us/windows-server/networking/core-network-guide/cncg/server-certs/install-the-certification-authority</a></li>\n          \n\t  <li><a href=\"https://msrc-blog.microsoft.com/2009/12/08/extended-protection-for-authentication/\" class=\"vulreflink\" rel=\"noopener\">https://msrc-blog.microsoft.com/2009/12/08/extended-protection-for-authentication/</a></li>\n          \n\t  <li><a href=\"https://github.com/topotam/PetitPotam\" class=\"vulreflink\" rel=\"noopener\">https://github.com/topotam/PetitPotam</a></li>\n          \n\t  <li><a href=\"https://posts.specterops.io/certified-pre-owned-d95910965cd2\" class=\"vulreflink\" rel=\"noopener\">https://posts.specterops.io/certified-pre-owned-d95910965cd2</a></li>\n          \n\t  <li><a href=\"https://www.exandroid.dev/2021/06/23/ad-cs-relay-attack-practical-guide/\" class=\"vulreflink\" rel=\"noopener\">https://www.exandroid.dev/2021/06/23/ad-cs-relay-attack-practical-guide/</a></li>\n          \n\t  \n\t  </ul>\n\t</div>\n      </div>\n      \n      <h3>Other Information</h3>\n        <div class=\"vulcontent\">\n          <table class=\"unstriped\">\n            <tbody>\n\t      \n              <tr>\n                <td width=\"200\"><b>CVE IDs:</b></td>\n\t\t<td>\n\t\t\n\t\t\n                \n\t\t</td>\n\t      </tr>\n\t      \n\t      <tr>\n\t\t<td>\n\t\t  <b>Date Public:</b>\n\t\t</td>\n                <td>2021-08-02</td>\n              </tr>\n              <tr>\n                <td><b>Date First Published:</b></td>\n                <td id=\"datefirstpublished\">2021-08-02</td>\n              </tr>\n              <tr>\n                <td><b>Date Last Updated: </b></td>\n                <td>2021-08-17 19:03 UTC</td>\n              </tr>\n              <tr>\n                <td><b>Document Revision: </b></td>\n                <td>13 </td>\n              </tr>\n            </tbody>\n          </table>\n\t</div>\n    </div>\n  </div>\n  <div class=\"large-3 medium-3 columns\">\n  <div class=\"sticky\">\n    <div class=\"sidebar-links\">\n      <ul class=\"menu vertical\">\n\t<li><a href=\"https://vuls.cert.org/confluence/display/VIN/Vulnerability+Note+Help\" rel=\"noopener\">About vulnerability notes</a></li>\n\t<li><a href=\"mailto:cert@cert.org?Subject=VU%23405600 Feedback\">Contact us about this vulnerability</a></li>\n\t<li><a href=\"https://vuls.cert.org/confluence/display/VIN/Case+Handling#CaseHandling-Givingavendorstatusandstatement\">Provide a vendor statement</a></li>\n      </ul>\n    </div>\n  </div>\n</div>\n\n</div>\n\n\n\n"
}