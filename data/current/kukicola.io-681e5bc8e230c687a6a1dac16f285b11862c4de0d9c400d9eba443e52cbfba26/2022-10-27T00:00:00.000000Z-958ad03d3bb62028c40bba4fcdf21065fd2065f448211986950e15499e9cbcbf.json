{
  "title":"Securing Rails applications with Content Security Policy",
  "date":"2022-10-27T00:00:00.000000Z",
  "author":"",
  "id":"https://kukicola.io/posts/securing-rails-app-with-csp",
  "link":"https://kukicola.io/posts/securing-rails-app-with-csp/",
  "content":"<h2 id=\"introduction\">Introduction</h2>\n<p>Nowadays web application security is a crucial and unfortunately sometimes a bit neglected matter.\nToday, I’ll focus on Content Security Policy - a handy mechanism that can protect our app from XSS attacks.\nIt’s not Rails-specific, it can (or even should) be implemented in every web application\nbut Rails provides great helpers to make implementation even easier.</p>\n\n<h2 id=\"xss-attacks\">XSS attacks</h2>\n<p>XSS (Cross-site scripting) is probably one of the most common vulnerabilities in web applications.\nIf our application is vulnerable, an attacker can inject malicious code into the victim’s browser,\nwhat can lead to many dangerous situations like, for example, session hijacking.</p>\n\n<p>Let’s take a simple example - we have a blog with comments. The attacker creates a new comment with the following content:</p>\n\n<div class=\"language-html highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Great article! <span class=\"nt\">&lt;script&gt;</span><span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">hacked!</span><span class=\"dl\">'</span><span class=\"p\">)</span><span class=\"nt\">&lt;/script&gt;</span>\n</code></pre></div></div>\n\n<p>If, for some reason, we won’t sanitize it while displaying the script will be executed in the browser of our visitors.\nBy default, ERB keeps us safe and escapes HTML, so code:</p>\n\n<div class=\"language-erb highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"cp\">&lt;%=</span> <span class=\"s1\">'abc &lt;script&gt;alert(&quot;hi!&quot;)&lt;/script&gt;'</span> <span class=\"cp\">%&gt;</span>\n</code></pre></div></div>\n<p>Will be rendered as plain text, <code class=\"language-plaintext highlighter-rouge\">&lt;</code> will be replaced with <code class=\"language-plaintext highlighter-rouge\">&amp;amp;lt;</code>.\nUnfortunately, there are some cases when it’s not that easy:</p>\n\n<div class=\"language-erb highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"cp\">&lt;%=</span><span class=\"o\">=</span> <span class=\"s2\">&quot;&lt;b&gt;</span><span class=\"si\">#{</span><span class=\"n\">comment</span><span class=\"p\">.</span><span class=\"nf\">username</span><span class=\"si\">}</span><span class=\"s2\">&lt;/b&gt;: </span><span class=\"si\">#{</span><span class=\"n\">comment</span><span class=\"p\">.</span><span class=\"nf\">content</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span> <span class=\"cp\">%&gt;</span>\n</code></pre></div></div>\n\n<p>Here, some careless developer wanted to display the username bolded, did it in a pretty bad way, and as a result created a vulnerability!\nBoth <code class=\"language-plaintext highlighter-rouge\">comment.username</code> and <code class=\"language-plaintext highlighter-rouge\">comment.content</code> aren’t escaped, because of <code class=\"language-plaintext highlighter-rouge\">&lt;%==</code> which was added to avoid escaping <code class=\"language-plaintext highlighter-rouge\">&lt;b&gt;</code>.\nIn this code, it’s pretty obvious but unfortunately, in many cases, it’s not.</p>\n\n<h2 id=\"content-security-policy-csp\">Content Security Policy (CSP)</h2>\n<p>There are many ways to prevent XSS or reduce its impact but CSP is a very simple to implement mechanism that eliminates\nmost of the vulnerabilities right away. Rails provides helpers which make implementation even easier.</p>\n\n<p>CSP allows us to specify trusted sources for all external resources like images or scripts.\nAdding such resources from untrusted sources will result in blocking them by the browser.</p>\n\n<p>In the newly created Rails app, we have a <code class=\"language-plaintext highlighter-rouge\">config/content_security_policy.rb</code> file with basic configuration.\nIt’s disabled by default but all we have to do is to uncomment the code in the file.\nIn version 7.0.4 it will look like this (after uncommenting):</p>\n\n<div class=\"language-ruby highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"no\">Rails</span><span class=\"p\">.</span><span class=\"nf\">application</span><span class=\"p\">.</span><span class=\"nf\">configure</span> <span class=\"k\">do</span>\n  <span class=\"n\">config</span><span class=\"p\">.</span><span class=\"nf\">content_security_policy</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">policy</span><span class=\"o\">|</span>\n    <span class=\"n\">policy</span><span class=\"p\">.</span><span class=\"nf\">default_src</span> <span class=\"ss\">:self</span><span class=\"p\">,</span> <span class=\"ss\">:https</span>\n    <span class=\"n\">policy</span><span class=\"p\">.</span><span class=\"nf\">font_src</span>    <span class=\"ss\">:self</span><span class=\"p\">,</span> <span class=\"ss\">:https</span><span class=\"p\">,</span> <span class=\"ss\">:data</span>\n    <span class=\"n\">policy</span><span class=\"p\">.</span><span class=\"nf\">img_src</span>     <span class=\"ss\">:self</span><span class=\"p\">,</span> <span class=\"ss\">:https</span><span class=\"p\">,</span> <span class=\"ss\">:data</span>\n    <span class=\"n\">policy</span><span class=\"p\">.</span><span class=\"nf\">object_src</span>  <span class=\"ss\">:none</span>\n    <span class=\"n\">policy</span><span class=\"p\">.</span><span class=\"nf\">script_src</span>  <span class=\"ss\">:self</span><span class=\"p\">,</span> <span class=\"ss\">:https</span>\n    <span class=\"n\">policy</span><span class=\"p\">.</span><span class=\"nf\">style_src</span>   <span class=\"ss\">:self</span><span class=\"p\">,</span> <span class=\"ss\">:https</span>\n    <span class=\"c1\"># Specify URI for violation reports</span>\n    <span class=\"c1\"># policy.report_uri &quot;/csp-violation-report-endpoint&quot;</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"c1\"># Generate session nonces for permitted importmap and inline scripts</span>\n  <span class=\"n\">config</span><span class=\"p\">.</span><span class=\"nf\">content_security_policy_nonce_generator</span> <span class=\"o\">=</span> <span class=\"o\">-&gt;</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"n\">request</span><span class=\"p\">.</span><span class=\"nf\">session</span><span class=\"p\">.</span><span class=\"nf\">id</span><span class=\"p\">.</span><span class=\"nf\">to_s</span> <span class=\"p\">}</span>\n  <span class=\"n\">config</span><span class=\"p\">.</span><span class=\"nf\">content_security_policy_nonce_directives</span> <span class=\"o\">=</span> <span class=\"sx\">%w(script-src)</span>\n\n  <span class=\"c1\"># Report violations without enforcing the policy.</span>\n  <span class=\"c1\"># config.content_security_policy_report_only = true</span>\n<span class=\"k\">end</span>\n</code></pre></div></div>\n\n<p>From now, our app will add a following header to the response:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Content-Security-Policy: default-src 'self' https:; font-src 'self' https: data:; img-src 'self' https: data:; object-src 'none'; script-src 'self' https: 'nonce-26ea5aaa858b26e451c1d9209e031f0a'; style-src 'self' https:\n</code></pre></div></div>\n\n<p>Let’s take a closer look at what it does. We have a list of different types of resources and their trusted sources.</p>\n<ul>\n  <li><code class=\"language-plaintext highlighter-rouge\">:self</code> - allows resources from current origin - so if your page is under <code class=\"language-plaintext highlighter-rouge\">somedomain.com</code> it will allow all resources within this domain.</li>\n  <li><code class=\"language-plaintext highlighter-rouge\">:https</code> - it will allow loading resources from any origin as long as it’s using HTTPS (HTTP requests will be blocked)</li>\n  <li><code class=\"language-plaintext highlighter-rouge\">:data</code> - data URIs (for example: <code class=\"language-plaintext highlighter-rouge\">data:image/gif;base64,R0lGODlhEAAQA...</code>)</li>\n  <li><code class=\"language-plaintext highlighter-rouge\">:none</code> - don’t allow loading objects from any source</li>\n</ul>\n\n<p>So looking at our config it will allow resources except for the <code class=\"language-plaintext highlighter-rouge\">object</code> type (<code class=\"language-plaintext highlighter-rouge\">&lt;object&gt;</code>, <code class=\"language-plaintext highlighter-rouge\">&lt;embed&gt;</code>, and <code class=\"language-plaintext highlighter-rouge\">&lt;applet&gt;</code>) to be loaded from our domain, HTTPS URLs, and Data URIs.\nAs you can see it’s easy to customize it per resource type. All types that are not present in the CSP header will fall back to <code class=\"language-plaintext highlighter-rouge\">default_src</code>.\nYou can check the full list of supported directives <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy#directives\">here</a>.</p>\n\n<p>We’ll take a look at the rest of the config later. Let’s focus on <code class=\"language-plaintext highlighter-rouge\">script-src</code> for now, since it’s the most important one when talking about XSS.\nApart from blocking scripts from the insecure connections, it will block the following things:</p>\n<ul>\n  <li>inline <code class=\"language-plaintext highlighter-rouge\">&lt;script&gt;</code> blocks</li>\n  <li>javascript in HTML attributes like <code class=\"language-plaintext highlighter-rouge\">onclick=&quot;doSomething()&quot;&quot;</code></li>\n  <li><code class=\"language-plaintext highlighter-rouge\">eval</code> and similar javascript methods</li>\n</ul>\n\n<p>Thanks to that the code from the previous example will be blocked, cool, right?\nThese are pretty solid settings for the start but can be improved.\nThe attacker can still inject code like <code class=\"language-plaintext highlighter-rouge\">&lt;script src=&quot;https://my.evil.site.com/dirty-script.js&quot;&gt;&lt;/script&gt;</code>.</p>\n\n<h2 id=\"improving-script-src-directive\">Improving script-src directive</h2>\n<p>To minimalize the risk of vulnerabilities we can remove <code class=\"language-plaintext highlighter-rouge\">:https</code> from <code class=\"language-plaintext highlighter-rouge\">script_src</code> and provide a list of allowed domains instead.\nIt may take some time, especially if you are using stuff like Google Analytics, Facebook pixels, etc.\nKeep in mind that subdomains are not included by default but you can use wildcards like <code class=\"language-plaintext highlighter-rouge\">'*.google-analytics.com'</code>.</p>\n\n<p>Blocked inline scripts may be a problem, sometimes we would like to use them for various reasons.\nWe could use <code class=\"language-plaintext highlighter-rouge\">:unsafe_inline</code> to allow them but it would significantly impact our security and to be honest make our policy pointless.\nLuckily, there is a better way to do this.</p>\n\n<h2 id=\"nonce\">Nonce</h2>\n<p>If you take another look at the generated header you’ll see the following content in the <code class=\"language-plaintext highlighter-rouge\">script-src</code> part:</p>\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>'nonce-26ea5aaa858b26e451c1d9209e031f0a'\n</code></pre></div></div>\n\n<p>It tells the browser to accept inline script with the following nonce value:</p>\n\n<div class=\"language-html highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nt\">&lt;script </span><span class=\"na\">nonce=</span><span class=\"s\">&quot;26ea5aaa858b26e451c1d9209e031f0a&quot;</span><span class=\"nt\">&gt;</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">hello</span><span class=\"dl\">'</span><span class=\"p\">)</span>\n  <span class=\"c1\">// script will be executed because it has correct noonce value</span>\n<span class=\"nt\">&lt;/script&gt;</span>\n</code></pre></div></div>\n\n<p>To keep it safe <code class=\"language-plaintext highlighter-rouge\">nonce</code> should be random (so the attacker won’t be able to guess it).\nBy default, Rails uses session id as a nonce but I recommend changing it.</p>\n\n<div class=\"language-ruby highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"nf\">content_security_policy_nonce_generator</span> <span class=\"o\">=</span> <span class=\"o\">-&gt;</span><span class=\"p\">(</span><span class=\"n\">_request</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"no\">SecureRandom</span><span class=\"p\">.</span><span class=\"nf\">base64</span><span class=\"p\">(</span><span class=\"mi\">16</span><span class=\"p\">)</span> <span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>Now nonce will be different on each request making it even safer.\nUsing session id has some advantages - it can be useful if you are using <a href=\"https://edgeguides.rubyonrails.org/caching_with_rails.html#conditional-get-caching\">Conditional GET caching</a> (random noonce will prevent pages from being cached)\nbut in most cases keeping it random is the best way to go.</p>\n\n<p>To use it for your inline script just add <code class=\"language-plaintext highlighter-rouge\">nonce: true</code> to the <code class=\"language-plaintext highlighter-rouge\">javascript_tag</code> helper:</p>\n\n<div class=\"language-erb highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"cp\">&lt;%=</span> <span class=\"n\">javascript_tag</span><span class=\"p\">(</span><span class=\"ss\">nonce: </span><span class=\"kp\">true</span><span class=\"p\">)</span> <span class=\"k\">do</span> <span class=\"cp\">%&gt;</span>\n  console.log('hello')\n<span class=\"cp\">&lt;%</span> <span class=\"k\">end</span> <span class=\"cp\">%&gt;</span>\n</code></pre></div></div>\n\n<h2 id=\"adding-csp-to-existing-application\">Adding CSP to existing application</h2>\n<p>Adding CSP to an existing application can be painful, especially if it’s a large app with a lot of javascript.\nTo do that without breaking anything we can use reporting feature.</p>\n\n<p>First, let’s uncomment the following line:</p>\n<div class=\"language-ruby highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"n\">policy</span><span class=\"p\">.</span><span class=\"nf\">report_uri</span> <span class=\"s2\">&quot;/csp-violation-report-endpoint&quot;</span>\n</code></pre></div></div>\n\n<p>It orders the browser to send policy violation reports to <code class=\"language-plaintext highlighter-rouge\">/csp-violation-report-endpoint</code>.\nYou’ll have to implement such endpoint and store reports somewhere - in DB or anywhere else.\nThe browser will send POST requests with a simple JSON body. It will include information about which rule was violated\nas well as blocked resource URLs.</p>\n\n<p>Keeping it like that will still result in blocking such resources but we can change that as well, by uncommenting:</p>\n\n<div class=\"language-ruby highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"nf\">content_security_policy_report_only</span> <span class=\"o\">=</span> <span class=\"kp\">true</span>\n</code></pre></div></div>\n\n<p>Now, we will receive notifications about violations but they won’t be blocked.</p>\n\n<p>Thanks to that we can easily integrate CSP into existing apps.\nFirst we setup our policy in report-only mode, we gather reports, fix our policy (by adding missing URLs) or our code (by adding nonce to inline scripts)\nand finally, we can turn off report-only mode.</p>\n\n<p>It’s worth mentioning that sometimes you’ll receive weird violation reports not really related to your app -\nthey are the results of different browser add-ons or extensions, you can safely ignore them.</p>\n\n<h2 id=\"summary\">Summary</h2>\n<p>So to summarize - CSP is a great mechanism that can improve the security of your app with relatively simple implementation.\nIt can block most of the potential XSS attacks by disabling the execution of scripts from untrusted sources.\nAlthough, you should still sanitize/escape user inputs since it doesn’t protect us from injecting HTML.</p>\n\n<p>If you’ll like to know all CSP directives and features please take a look at <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy\">MDN</a>.</p>\n\n<p>Let me know if you’ll like to see more security-related articles!</p>"
}