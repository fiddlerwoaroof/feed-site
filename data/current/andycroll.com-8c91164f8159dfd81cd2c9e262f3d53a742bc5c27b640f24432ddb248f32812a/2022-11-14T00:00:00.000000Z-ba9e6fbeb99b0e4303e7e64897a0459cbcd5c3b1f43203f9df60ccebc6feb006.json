{
  "title":"Safely Remove a Column from an Active Record Model",
  "date":"2022-11-14T00:00:00.000000Z",
  "author":null,
  "id":"https://andycroll.com/ruby/safely-remove-a-column-field-from-active-record",
  "link":"https://andycroll.com/ruby/safely-remove-a-column-field-from-active-record/",
  "content":"<p>Adding and deploying new columns to an existing Active Record model is often straightforward. Typically the first deployment runs your migrations, and then new code that uses the recently-added database column is released afterward.</p>\n\n<p>However, removing a column tends to cause problems. Active Record caches database columns when it spins up a Rails application. When the column is removed from the database table it raises exceptions until your app reboots or redeploys.</p>\n\n<p>It’s also worth a multi-step strategy when removing columns in your database.</p>\n\n<h2 id=\"use\">Use…</h2>\n\n<p>…this multi-step strategy:</p>\n\n<p>First tell Active Record to ignore the column. This stops the rest of your application being able to reference this column.</p>\n\n<div class=\"language-ruby highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">class</span> <span class=\"nc\">Thing</span> <span class=\"o\">&lt;</span> <span class=\"no\">ApplicationRecord</span>\n  <span class=\"c1\"># ...</span>\n  <span class=\"nb\">self</span><span class=\"p\">.</span><span class=\"nf\">ignored_columns</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s2\">&quot;old_column&quot;</span><span class=\"p\">]</span>\n  <span class=\"c1\"># ...</span>\n<span class=\"k\">end</span>\n</code></pre></div></div>\n\n<p>You can use your test suite to find places you might be still using the column, if you haven’t already removed usage of it, in your application. Once your tests are passing, deploy this code.</p>\n\n<p>Then, create the migration to remove the actual database column:</p>\n\n<div class=\"language-ruby highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">class</span> <span class=\"nc\">RemoveOldColumnFromThings</span> <span class=\"o\">&lt;</span> <span class=\"no\">ActiveRecord</span><span class=\"o\">::</span><span class=\"no\">Migration</span><span class=\"p\">[</span><span class=\"mf\">7.0</span><span class=\"p\">]</span>\n  <span class=\"k\">def</span> <span class=\"nf\">change</span>\n    <span class=\"n\">remove_column</span> <span class=\"ss\">:things</span><span class=\"p\">,</span> <span class=\"ss\">:old_column</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div></div>\n\n<p>Then deploy, migrating the column into oblivion.</p>\n\n<p>After that, in a final change, remove the <code class=\"language-plaintext highlighter-rouge\">ignored_columns</code> line you added for the initial step and deploy once more.</p>\n\n<h2 id=\"why\">Why?</h2>\n\n<p>In a larger team or application, having stable and predictable ways to change your database, without causing errors or downtime, is very important.</p>\n\n<p>Rails gives you built-in tools to change your database, but doing it in the production environment of a busy application often requires greater care.</p>\n\n<p>To a certain extent having good test coverage and a healthy process for deploying multiple times a day is a prerequisite of this method given that this “simple” column removal requires three separate deployments.</p>\n\n<h3 id=\"theres-a-gem-for-that\">There’s a gem for that!</h3>\n\n<p>Look into the <a href=\"https://github.com/ankane/strong_migrations\"><code class=\"language-plaintext highlighter-rouge\">strong_migrations</code> gem</a> that was initially developed at InstaCart.</p>\n\n<p>It blocks potentially dangerous migrations and warns you, with lovely helpful instructions, if your code might block reads or writes for more than a few seconds or, like in this case, has a good chance of causing other application errors.</p>\n\n<h2 id=\"why-not\">Why not?</h2>\n\n<p>In projects with low traffic, or during the early stages of a Rails application, this isn’t strictly necessary. In cases like this, you’re likely fine putting up with a handful of errors on deploy.</p>\n\n<p>Still, this is a good habit to begin to exercise as early as possible!</p>\n"
}